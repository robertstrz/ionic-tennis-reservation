/*!CK:3716642422!*//*1433729743,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["UPyg6"]); }

__d("AjaxRequest",["ErrorUtils","Keys","URI","UserAgent_DEPRECATED","getSameOriginTransport","setTimeoutAcrossTransitions","PHPQuerySerializer","copyProperties"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){b.__markCompiled&&b.__markCompiled();function o(s,t,u){this.xhr=k();if(!(t instanceof i))t=new i(t);if(u&&s=='GET'){t.setQueryData(u);}else this._params=u;this.method=s;this.uri=t;this.xhr.open(s,t);}var p=window.XMLHttpRequest&&('withCredentials' in new XMLHttpRequest());o.supportsCORS=function(){return p;};o.ERROR='ar:error';o.TIMEOUT='ar:timeout';o.PROXY_ERROR='ar:proxy error';o.TRANSPORT_ERROR='ar:transport error';o.SERVER_ERROR='ar:http error';o.PARSE_ERROR='ar:parse error';o.SERVICE_UNAVAILABLE='ar:noservice';o._inflight=[];function q(){var s=o._inflight;o._inflight=[];s.forEach(function(t){t.abort();});}function r(s){s.onJSON=s.onError=s.onSuccess=null;clearTimeout(s._timer);if(s.xhr&&s.xhr.readyState<4){s.xhr.abort();s.xhr=null;}o._inflight=o._inflight.filter(function(t){return t&&t!=s&&t.xhr&&t.xhr.readyState<4;});}n(o.prototype,{timeout:60000,streamMode:true,prelude:/^for \(;;\);/,status:null,_eol:-1,_call:function(s){if(this[s])this[s](this);},_parseStatus:function(){var s;try{this.status=this.xhr.status;s=this.xhr.statusText;}catch(t){if(this.xhr.readyState>=4){this.errorType=o.TRANSPORT_ERROR;this.errorText=t.message;}return;}if(this.status===0&&!(/^(file|ftp)/.test(this.uri))){this.errorType=o.TRANSPORT_ERROR;}else if(this.status>=100&&this.status<200){this.errorType=o.PROXY_ERROR;}else if(this.status>=200&&this.status<300){return;}else if(this.status>=300&&this.status<400){this.errorType=o.PROXY_ERROR;}else if(this.status>=400&&this.status<500){this.errorType=o.SERVER_ERROR;}else if(this.status===503){this.errorType=o.SERVICE_UNAVAILABLE;}else if(this.status>500&&this.status<600){this.errorType=o.PROXY_ERROR;}else if(this.status==1223){return;}else if(this.status>=12001&&this.status<=12156){this.errorType=o.TRANSPORT_ERROR;}else{s='unrecognized status code: '+this.status;this.errorType=o.ERROR;}if(!this.errorText)this.errorText=s;},_parseResponse:function(){var s,t=this.xhr.readyState;try{s=this.xhr.responseText||'';}catch(u){if(t>=4){this.errorType=o.ERROR;this.errorText='responseText not available - '+u.message;}return;}while(this.xhr){var v=this._eol+1,w=this.streamMode?s.indexOf('\n',v):s.length;if(w<0&&t==4)w=s.length;if(w<=this._eol)break;var x=s;if(this.streamMode)x=s.substr(v,w-v).replace(/^\s*|\s*$/g,'');if(v===0&&this.prelude)if(this.prelude.test(x))x=x.replace(this.prelude,'');this._eol=w;if(x){try{this.json=JSON.parse(x);}catch(u){var y=(/(<body[\S\s]+?<\/body>)/i).test(s)&&RegExp.$1,z={message:u.message,'char':v,excerpt:((v===0&&y)||x).substr(512)};this.errorType=o.PARSE_ERROR;this.errorText='parse error - '+JSON.stringify(z);return;}g.applyWithGuard(this._call,this,['onJSON']);}}},_onReadyState:function(){var s=this.xhr&&this.xhr.readyState||0;if(this.status==null&&s>=2)this._parseStatus();if(!this.errorType&&this.status!=null)if((s==3&&this.streamMode)||s==4)this._parseResponse();if(this.errorType||s==4){this._time=Date.now()-this._sentAt;this._call(!this.errorType?'onSuccess':'onError');r(this);}},send:function(s){this.xhr.onreadystatechange=function(){g.applyWithGuard(this._onReadyState,this,arguments);}.bind(this);var t=this.timeout;if(t)this._timer=l((function(){this.errorType=o.TIMEOUT;this.errorText='timeout';this._time=Date.now()-this._sentAt;this._call('onError');r(this);}).bind(this),t);o._inflight.push(this);if(this.method=='POST')this.xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');this._sentAt=Date.now();this.xhr.send(s?m.serialize(s):'');},abort:function(){r(this);},toString:function(){var s='[AjaxRequest readyState='+this.xhr.readyState;if(this.errorType)s+=' errorType='+this.errorType+' ('+this.errorText+')';return s+']';},toJSON:function(){var s={json:this.json,status:this.status,errorType:this.errorType,errorText:this.errorText,time:this._time};if(this.errorType)s.uri=this.uri;for(var t in s)if(s[t]==null)delete s[t];return s;}});if(window.addEventListener&&j.firefox())window.addEventListener('keydown',function(event){if(event.keyCode===h.ESC)event.prevent();},false);if(window.attachEvent)window.attachEvent('onunload',q);e.exports=o;},null);
__d("SystemEvents",["Arbiter","ErrorUtils","SystemEventsInitialData","UserAgent_DEPRECATED","copyProperties","setIntervalAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k,l){b.__markCompiled&&b.__markCompiled();var m=new g(),n=[],o=1000;l(function(){for(var y=0;y<n.length;y++)n[y]();},o);function p(){return (/c_user=(\d+)/.test(document.cookie)&&RegExp.$1)||0;}function q(){return i.ORIGINAL_USER_ID;}var r=q(),s=navigator.onLine;function t(){if(!s){s=true;m.inform(m.ONLINE,s);}}function u(){if(s){s=false;m.inform(m.ONLINE,s);}}if(j.ie()){if(j.ie()>=11){window.addEventListener('online',t,false);window.addEventListener('offline',u,false);}else if(j.ie()>=8){window.attachEvent('onload',function(){document.body.ononline=t;document.body.onoffline=u;});}else n.push(function(){(navigator.onLine?t:u)();});}else if(window.addEventListener)if(!j.chrome()){window.addEventListener('online',t,false);window.addEventListener('offline',u,false);}var v=r;n.push(function(){var y=p();if(v!=y){m.inform(m.USER,y);v=y;}});var w=Date.now();function x(){var y=Date.now(),z=y-w,aa=z<0||z>10000;w=y;if(aa)m.inform(m.TIME_TRAVEL,z);return aa;}n.push(x);n.push(function(){if(window.onerror!=h.onerror)window.onerror=h.onerror;});k(m,{USER:'SystemEvents/USER',ONLINE:'SystemEvents/ONLINE',TIME_TRAVEL:'SystemEvents/TIME_TRAVEL',isPageOwner:function(y){return (y||p())==r;},isOnline:function(){return j.chrome()||s;},checkTimeTravel:x});e.exports=m;},null);
__d("ChannelSubdomain",["Event","JSLogger","Run","setTimeoutAcrossTransitions","LogHistory","WebStorage"],function(a,b,c,d,e,f,g,h,i,j){b.__markCompiled&&b.__markCompiled();var k=b('LogHistory').getInstance('channel'),l=b('WebStorage').getLocalStorage(),m=h.create('channel'),n='channel_sub:',o=7,p=100*1000,q=null,r;function s(){if(r){clearTimeout(r);r=null;}if(l&&q!=null)l.removeItem(n+q);q=null;}function t(u,v,w){var x=(u-1)*o;if(w){if(r)clearTimeout(r);q=r=null;}if(v==null)v=Math.floor(Math.random()*x);if(q==null)if(l){var y=[];for(var z=0;z<l.length;z++){var aa=l.key(z);if(aa.indexOf(n)===0){var ba=parseInt(aa.substr(n.length),10);y[ba]=parseInt(l.getItem(aa),10);}}var ca=Date.now()-p;for(z=0;z<x;z++){var da=(z+v)%x;if(!y[da]||y[da]<ca){q=da;break;}}if(q!=null){var ea=function(){try{l.setItem(n+q,Date.now());}catch(fa){k.warn('subdomain set failed',fa.message);}r=j(ea,p/2);};ea();}else{k.warn('no channel subdomain',y);m.error('subdomain_overflow');}if(typeof window.onpageshow!='undefined'){g.listen(window,'pagehide',s);}else i.onUnload(s);}else q=v;return q==null?null:q%o;}e.exports={allocate:t,clear:s};},null);
__d("DocRPC",["ErrorUtils"],function(a,b,c,d,e,f,g){b.__markCompiled&&b.__markCompiled();var h={_apis:{},_dispatch:function(i){var j;try{i=JSON.parse(i);}catch(k){throw new Error('DocRPC unparsable dispatch: "'+i+'"');}if(h._apis.hasOwnProperty(i.api)){var l=h._apis[i.api];if(l[i.method])j=g.applyWithGuard(l[i.method],l,i.args);}if(j===(void 0))j=null;return JSON.stringify(j);},publish:function(i,j){h._apis[j]=i;},proxy:function(i,j,k){var l={};k.forEach(function(m){l[m]=function(){var n={api:j,method:m,args:Array.prototype.slice.call(arguments)},o;try{if(i.closed)throw new Error('DocRPC window closed');o=i.DocRPC._dispatch(JSON.stringify(n));}catch(p){g.reportError(p);return;}if(typeof(o)=='string')try{o=JSON.parse(o);}catch(p){throw new Error('DocRPC '+j+'.'+m+' unparsable return: "'+o+'"');}return o;};});return l;}};e.exports=a.DocRPC=h;},null);
__d("ChannelTransport",["AjaxRequest","ChannelConstants","DocRPC","LogHistory","URI","copyProperties","bind","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){b.__markCompiled&&b.__markCompiled();var o=j.getInstance('channel');function p(){return (1048576*Math.random()|0).toString(36);}function q(z,aa){var ba=z.subdomain;ba=ba===null?'':(ba+'-');var ca=new k(aa).setDomain(ba+z.host+'.'+z.domain).setPort(z.port).setSecure(new k(window.location.href).isSecure());return ca;}function r(z){var aa={partition:z.partition,cb:p()};if(z.sticky_token)aa.sticky_token=z.sticky_token;var ba=q(z,'/p').setQueryData(aa);o.log('start_p',{uri:ba.toString()});var ca=new g('GET',ba);if(g.supportsCORS())ca.xhr.withCredentials=true;var da=function(ea){o.log('finish_p',{xhr:ea.toJSON?ea.toJSON():ea});};ca.timeout=z.P_TIMEOUT;ca.onError=ca.onSuccess=da;ca.send();}function s(z,aa,ba){var ca=new Image(),da=0,ea=function(ha){ca.abort();return ha?aa():ba();};ca.onload=function(){o.log('ping_ok',{duration:Date.now()-da});ea(true);};ca.onerror=function(){r(z);ea(false);};var fa=n(ca.onerror,10000);ca.abort=function(){if(fa){clearTimeout(fa);fa=null;}ca.onload=ca.onerror=null;};var ga={partition:z.partition,cb:p()};if(z.sticky_token)ga.sticky_token=z.sticky_token;if(z.sticky_pool)ga.sticky_pool=z.sticky_pool;if(z.lastRequestErrorReason){ga.reason=z.lastRequestErrorReason;z.lastRequestErrorReason=null;}if(z.uid&&z.viewerUid){ga.uid=z.uid;ga.viewer_uid=z.viewerUid;}if(z.watchdog&&z.watchdog.enabled)ga.wtc=z.watchdog.doSerialize();da=Date.now();ca.src=q(z,'/ping').setQueryData(ga);return ca;}function t(z){var aa={channel:z.user_channel,partition:z.partition,clientid:z.sessionID,cb:p(),cap:0,uid:z.uid,viewer_uid:z.viewerUid};if(z.sticky_token)aa.sticky_token=z.sticky_token;if(z.sticky_pool)aa.sticky_pool=z.sticky_pool;if(z.is_offline||z.shouldSuppressPresence){aa.state='offline';}else aa.state='active';if(aa.state===z.lastPresenceState)return;z.lastPresenceState=aa.state;if(z.profile)aa.profile=z.profile;if(z.capabilities)aa.cap=z.capabilities;var ba=q(z,'/active_ping').setQueryData(aa),ca=new g('GET',ba);if(g.supportsCORS())ca.xhr.withCredentials=true;ca.onError=function(da){o.warn('active_ping_error');};ca.onSuccess=function(da){o.log('active_ping_ok');};ca.timeout=z.P_TIMEOUT;ca.send();}function u(z,aa,ba,ca){var da=new Date(),ea=-1;if(z.userActive>0){ea=(da-z.userActive)/1000|0;if(ea<0)o.warn('idle_regression',{idleTime:ea,now:da.getTime(),userActive:z.userActive});}var fa={channel:z.user_channel,seq:z.seq,partition:z.partition,clientid:z.sessionID,cb:p(),idle:ea,cap:0};if(!!z.watchdog&&z.watchdog.enabled)fa.wtc=z.watchdog.doSerialize();fa.msgs_recv=z.estimatedReceived;if(z.uid&&z.viewerUid){fa.uid=z.uid;fa.viewer_uid=z.viewerUid;}if(z.stableDeviceId)fa.sdi=1;if(z.sticky_token)fa.sticky_token=z.sticky_token;if(z.sticky_pool)fa.sticky_pool=z.sticky_pool;if('trace_id' in z)fa.traceid=z.trace_id;if(z.is_offline||z.shouldSuppressPresence){fa.state='offline';}else if(z.userActive>0&&ea<60)fa.state='active';z.lastPresenceState=fa.state;if(z.streamingCapable){fa.mode='stream';fa.format='json';}if(z.profile)fa.profile=z.profile;if(z.capabilities)fa.cap=z.capabilities;var ga=q(z,'/pull').setQueryData(fa),ha=z.fantail_enabled?'POST':'GET',ia=new g(ha,ga);if(!z.sticky_pool&&z.msgr_region)ia.xhr.setRequestHeader('X-MSGR-Region',z.msgr_region);if(g.supportsCORS())ia.xhr.withCredentials=true;ia.timeout=z.streamingCapable?z.STREAMING_TIMEOUT:z.LONGPOLL_TIMEOUT;ia.onJSON=aa;ia.onSuccess=ba;ia.onError=function(){var la=(this.status==12002&&this._time>=z.MIN_12002_TIMEOUT)||(this.status==504&&this._time>=z.MIN_504_TIMEOUT),ma=la?ba:ca;return ma&&ma.apply(this,arguments);};if(z.fantail_logs&&z.fantail_logs.length>0){var ja={};for(var ka=0;ka<z.fantail_logs.length;ka++)l(ja,z.fantail_logs[ka]);ia.send(ja);z.fantail_logs=[];}else ia.send();z.inStreaming=z.streamingCapable;return ia;}function v(z){this.manager=z;(this.init&&this.init());}function w(z){v.apply(this,arguments);}l(w.prototype,{logName:'CORS',enterState:function(z,aa){if(this._request){this._request.abort();this._request=null;}if(z=='init')n(m(this.manager,'exitState',{status:h.OK,stateId:aa.stateId}),3000);if(!/pull|ping/.test(z))return;var ba=this.manager;if(z=='ping'){this._request=s(aa,m(ba,'exitState',{status:h.OK,stateId:aa.stateId}),m(ba,'exitState',{status:h.ERROR,stateId:aa.stateId}));}else if(z=='pull')this._request=u(aa,m(ba,'_processTransportData',aa.stateId),m(ba,'exitState',{status:h.OK,stateId:aa.stateId}),m(ba,'exitState',{status:h.ERROR,stateId:aa.stateId}));}});function x(z){o.log('iframe_init_constructor');v.apply(this,arguments);this._iframe=document.createElement('iframe');this._iframe.style.display='none';document.body.appendChild(this._iframe);i.publish(this,'outerTransport');}l(x.prototype,{logName:'iframe',_initIframe:function(z){o.log('iframe_init_start');window.onchanneliframeready=function(){o.log('iframe_resources');return z.resources;};window.onchanneliframeloaded=function(){o.log('iframe_loaded');};if(z){this._iframeURI=q(z,z.path);if(z.resources){var aa=this._iframeURI.getDomain();z.resources=z.resources.map(function(da){var ea=new k(da);if(ea.getPath().startsWith('/intern/rsrc.php')&&ea.getQueryData().origin!==(void 0))return ea.addQueryData('origin',aa).toString();return da;});}if(z.bustIframe){var ba={partition:z.partition,cb:p()};this._iframeURI.setQueryData(ba);}}else this._iframeURI='about:blank';this._iframeProxy=null;try{this._iframe.contentWindow.location.replace(this._iframeURI);o.log('iframe_uri_set');}catch(ca){o.error('iframe_uri_set_error',ca);this.exitState({status:h.ERROR,stateId:z.stateId},ca+'');}},enterState:function(z,aa){if(z=='init'){this._initIframe(aa);}else if(/idle|ping|pull/.test(z)){if(this._iframeProxy){this._iframeProxy.enterState.apply(this._iframeProxy,arguments);}else if(z!='idle')this.exitState({status:h.ERROR,stateId:aa.stateId},'iframe not yet loaded');}else if(z=='shutdown')this._initIframe();},_processTransportData:function(){this.manager._processTransportData.apply(this.manager,arguments);},exitState:function(z){if(this.manager.state=='init'&&z.status==h.OK)this._iframeProxy=i.proxy(this._iframe.contentWindow,'innerTransport',['enterState'],(this._iframeURI+'').replace(/iframe.*/,''));if(/ping|pull/.test(this.manager.state)&&!this._iframeProxy)return;this.manager.exitState.apply(this.manager,arguments);}});function y(){this.init=this.init.bind(this);v.apply(this,arguments);}l(y.prototype,{logName:'iframe(inner)',init:function(){i.publish(this,'innerTransport');try{var aa=i.proxy(window.parent,'outerTransport',['_processTransportData','exitState'],top.DocRPC.origin);l(this,aa);this.exitState({status:h.OK,stateId:1e+06});}catch(z){o.error('iframe_inner_init_error',z);}},enterState:function(z,aa){if(this._request){this._request.abort();this._request=null;}if(z=='ping'){this._request=s(aa,m(this,'exitState',{status:h.OK,stateId:aa.stateId}),m(this,'exitState',{status:h.ERROR,stateId:aa.stateId}));}else if(z=='pull')this._request=u(aa,m(this,'_processTransportData',aa.stateId),m(this,'exitState',{status:h.OK,stateId:aa.stateId}),m(this,'exitState',{status:h.ERROR,stateId:aa.stateId}));}});e.exports={getURI:q,Transport:v,CORSTransport:w,IframeTransport:x,IframeInnerTransport:y,sendActivePing:t};},null);
__d("FBAjaxRequest",["AjaxRequest","copyProperties","getAsyncParams"],function(a,b,c,d,e,f,g,h,i){b.__markCompiled&&b.__markCompiled();function j(k,l,m){m=h(i(k),m);var n=new g(k,l,m);n.streamMode=false;var o=n._call;n._call=function(p){if(p=='onJSON'&&this.json){if(this.json.error){this.errorType=g.SERVER_ERROR;this.errorText='AsyncResponse error: '+this.json.error;}this.json=this.json.payload;}o.apply(this,arguments);};n.ajaxReqSend=n.send;n.send=function(p){this.ajaxReqSend(h(p,m));};return n;}e.exports=j;},null);
__d("MovingStat",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();function g(h){h=h||60000;var i={t:new Date(),count:0,v:0},j=i,k=0,l=0;function m(){var n=new Date()-h;while(j&&j.next&&j.t<n){k-=j.v;l-=j.count;j=j.next;}}this.add=function(n){k+=n;l++;var o=new Date();if(o-i.t<1000){i.v+=n;i.count++;}else{i.next={t:o,v:n,count:1};i=i.next;m();}};this.tally=function(n){n=n||1000;m();return {sum:k,count:l,timeAverage:k*n/h};};}e.exports=g;},null);
__d("VideoCallSupport",["ChannelConstants","RTCConfig","UserAgent"],function(a,b,c,d,e,f,g,h,i){b.__markCompiled&&b.__markCompiled();var j={isSendWebrtcSupported:function(){return h.SendNewVCGK;},isReceiveWebrtcSupported:function(){return h.ReceiveNewVCGK;},isVideoInteropSupported:function(){return h.VideoInteropGK;},isVideoCallSupported:function(){return j.isSendWebrtcSupported();},isWebrtcSupported:function(){return (i.isBrowser('Chrome >= 28')||i.isBrowser('Firefox >= 25')||i.isBrowser('Opera >= 20'));},isOSSupported:function(){return !i.isPlatform('Android')&&!i.isPlatform('iOS');},getCapabilities:function(){var k=0;if(this.isReceiveWebrtcSupported())k=g.CAPABILITY_VOIP_INTEROP;return k;}};e.exports=j;},null);
__d("RTISession",["URI","AjaxRequest","copyProperties","invariant","ErrorUtils"],function(a,b,c,d,e,f,g,h,i,j,k){b.__markCompiled&&b.__markCompiled();'use strict';var l='.facebook.com';function m(n,o,p,q,r,s,t,u,v){j(n);j(q);j(r);this.domain=n;this.port=o;this.edgePoolName=p;this.stickyToken=q;this.loggedInId=r;this.accountId=s;this.clientProfile=t||'desktop';this.clientId=u;this.capabilities=v;}m.prototype.issueRequest=function(n,o,p,q,r){j(n);j(o);j(q);var s=this.domain.length-l.length,t=s>0&&this.domain.indexOf(l,s)!==-1,u=t?this.domain:this.domain+l,v=(1048576*Math.random()|0).toString(36),w={cb:v,sticky_token:this.stickyToken,uid:this.loggedInId,viewer_uid:this.accountId,sticky_pool:this.edgePoolName,profile:this.clientProfile,clientid:this.clientId,cap:this.capabilities};for(var x in w)j(!o[x]);i(w,o);var y=new g(n).setDomain(u).setPort(this.port).setSecure(new g(window.location.href).isSecure()).setQueryData(w),z=p?'POST':'GET',aa=new h(z,y);aa.timeout=r?r*1000:30000;if(aa.xhr)aa.xhr.withCredentials=true;var ba={};aa.onSuccess=function(){};aa.onJSON=(function(){ba.data=aa.json;ba.error=null;k.applyWithGuard(q,this,[ba]);}).bind(this);aa.onError=(function(){ba.data=null;ba.error=aa.errorType||'error';k.applyWithGuard(q,this,[ba]);}).bind(this);aa.send(JSON.stringify(p));};e.exports=m;},null);
__d("ChannelManager",["AjaxRequest","Arbiter","AsyncRequest","ChannelConstants","ChannelInitialData","ChannelSubdomain","ChannelTransport","ChatVisibility","DTSG","Env","FBAjaxRequest","ISB","JSLogger","MessagingRealtimeConstants","MovingStat","PresenceCookieManager","PresenceState","PresenceUtil","Run","SystemEvents","URI","UserActivity","VideoCallSupport","RTISession","copyProperties","createArrayFromMixed","errorCode","setIntervalAcrossTransitions","setTimeoutAcrossTransitions","WebStorage"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba,ca,da,ea,fa,ga,ha,ia){b.__markCompiled&&b.__markCompiled();var ja=b('WebStorage').getSessionStorage(),ka='chproxy_base_sess',la,ma=s.create('channel'),na=null;function oa(db){na=db;}var pa={idle:{ok:'init!'},init:{ok:'pull!',error:'reconnect',sys_online:'init',sys_timetravel:'init'},pull:{ok:'pull!',error:'ping',error_missing:'pull',error_msg_type:'pull',refresh_0:'reconnect',refresh_110:'reconnect',refresh_111:'reconnect',refresh_112:'pull',refresh_113:'pull',refresh_117:'reconnect'},ping:{ok:'pull!',error:'ping',error_stale:'reconnect!'},reconnect:{ok:'init!',error:'reconnect',sys_online:'reconnect',sys_timetravel:'reconnect'},shutdown:{},_all:{error_max:'shutdown!',error_shutdown:'shutdown!',sys_owner:'reconnect',sys_nonowner:'idle!',sys_online:'ping',sys_offline:'idle!',sys_timetravel:'ping'}},qa={reconnectOverrideTimeMillis:Date.now(),userActive:Date.now(),lastPresenceState:null,lastRequestErrorReason:null,seq:0,estimatedReceived:0,fantail_logs:[],sessionID:(Math.random()*2147483648|0).toString(16),stableDeviceId:false,capabilities:ca.getCapabilities(),streamingCapable:false,inStreaming:false,shouldSuppressPresence:w.shouldSuppress(),LONGPOLL_TIMEOUT:60000,STREAMING_TIMEOUT:60000,P_TIMEOUT:30000,IFRAME_LOAD_TIMEOUT:30000,MIN_RETRY_INTERVAL:5000,MAX_RETRY_INTERVAL:320000,MIN_12002_TIMEOUT:9000,MIN_504_TIMEOUT:20000,STALL_THRESHOLD:180000,JUMPSTART_THRESHOLD:90000,MIN_INIT_PROBE_DELAY:3000,INIT_PROBE_DELAY_RANDOMIZE_RANGE:12000,CHANNEL_PROXY_REPORTING_MIN_INTERVAL:10000,PROBE_DELAY:60000,PROBE_HEARTBEATS_INTERVAL_LOW:1000,PROBE_HEARTBEATS_INTERVAL_HIGH:5000,STREAMING_EXIT_STATE_ON_CONTINUE:false,FANTAIL_QUEUE_CAPACITY:50},ra={MAX_CONTINUOUS_PULL_FAILS:3,enabled:false,uptimeMillis:Date.now(),timeInGoodStatesStartMillis:Date.now(),timeInGoodStatesMillis:0,initialized:false,firstPullSentTimeMillis:Date.now(),accumulatedPullTimeMillis:0,pullStartTimeMillis:0,pingCount:0,pullCount:0,continuousPullFails:0,getTimeSinceFirstPullSentSeconds:function(){return (Date.now()-this.firstPullSentTimeMillis)/1000;},getUptimeSeconds:function(){return (Date.now()-this.uptimeMillis)/1000;},getAccumulatedPullTimeSeconds:function(){var db=this.accumulatedPullTimeMillis,eb=Date.now();if(this.pullStartTimeMillis>0&&eb-this.pullStartTimeMillis<=qa.LONGPOLL_TIMEOUT)db+=(eb-this.pullStartTimeMillis);var fb=db/1000;if(fb>=this.getTimeSinceFirstPullSentSeconds())this.initialize();return fb;},getPingToPullRatio:function(){return this.pullCount===0?0:this.pingCount/this.pullCount;},reportPullSent:function(){if(!this.enabled)return;if(!this.initialized)this.initialize();this.pullStartTimeMillis=Date.now();},initialize:function(){this.initialized=true;this.firstPullSentTimeMillis=Date.now();this.pullStartTimeMillis=0;this.accumulatedPullTimeMillis=0;this.pingCount=0;this.pullCount=0;this.timeInGoodStatesStartMillis=Date.now();this.timeInGoodStatesMillis=0;this.uptimeMillis=Date.now();},reportPullReturned:function(db,eb){if(!this.enabled)return;if(this.pullStartTimeMillis>0){this.accumulatedPullTimeMillis+=(Date.now()-this.pullStartTimeMillis);if(db){this.pullCount++;this.continuousPullFails=0;}else this.continuousPullFails++;}this.pullStartTimeMillis=0;},reportPingSent:function(){if(!this.enabled)return;this.pingCount++;},isGoodState:function(db){return db.indexOf('pull')===0||db.indexOf('init')===0||db.indexOf('idle')===0;},getTotalTimeInGoodStatesSeconds:function(){var db=this.timeInGoodStatesMillis;if(this.timeInGoodStatesStartMillis>0)db+=(Date.now()-this.timeInGoodStatesStartMillis);return db/1000;},clientEnteredState:function(db){if(!this.enabled)return;var eb=this.isGoodState(db);if(eb&&this.timeInGoodStatesStartMillis===0){this.timeInGoodStatesStartMillis=Date.now();}else if(!eb&&this.timeInGoodStatesStartMillis>0){this.timeInGoodStatesMillis=Date.now()-this.timeInGoodStatesStartMillis;this.timeInGoodStatesStartMillis=0;}},transportEnteredState:function(db){if(!this.enabled)return;if(db.indexOf('pull')===0){this.reportPullSent();}else if(db.indexOf('ping')===0&&qa.lastRequestErrorReason!==j.SYS_TIMETRAVEL&&qa.lastRequestErrorReason!==j.SYS_ONLINE&&qa.lastRequestErrorReason!==j.SYS_OWNER&&qa.lastRequestErrorReason!==j.SYS_NONOWNER)this.reportPingSent();},doSerialize:function(){if(!this.enabled)return "";return (this.getTimeSinceFirstPullSentSeconds()).toFixed(0)+','+(this.getAccumulatedPullTimeSeconds()).toFixed(0)+','+(this.getPingToPullRatio()).toFixed(3)+','+(this.getUptimeSeconds()).toFixed(0)+','+(this.getTotalTimeInGoodStatesSeconds()).toFixed(0);}},sa=1,ta={},ua=0;function va(){return i.lastSuccessTime?Math.round((Date.now()-i.lastSuccessTime)/1000):-1;}function wa(){var db={};if(la.getConfig('host'))db[la.getConfig('user_channel')]=la.getConfig('seq',0);return db;}function xa(){var db=Date.now(),eb=Date.now(),fb={total:0},gb='idle',hb=false;z.subscribe([z.USER,z.ONLINE,z.TIME_TRAVEL],function(kb,lb){za(true);eb=null;la.lastPullTime=Date.now();var mb;switch(kb){case z.USER:mb=z.isPageOwner()?j.SYS_OWNER:j.SYS_NONOWNER;break;case z.ONLINE:mb=lb?j.SYS_ONLINE:j.SYS_OFFLINE;break;case z.TIME_TRAVEL:mb=j.SYS_TIMETRAVEL;break;}la.exitState({status:mb,stateId:sa});});var ib=function(kb,lb){var mb=Date.now(),nb;if(lb){db=mb;nb=lb.nextState||lb.state;}else nb=gb;z.checkTimeTravel();if(eb){var ob=Math.round((mb-eb)/1000);if(ob>0){fb[gb]=(fb[gb]||0)+ob;fb.total+=ob;}}gb=nb;eb=mb;if(!kb){fb.lastSuccessTime=va();fb.online=z.isOnline();ma.log('rollup',fb);}};h.subscribe(j.ON_ENTER_STATE,ib);ha(ib,60000);h.subscribe(s.DUMP_EVENT,function(kb,lb){lb.channelRollup=fb;});var jb=function(){if(la.isShutdown()||la.shouldIdle())return;z.checkTimeTravel();var kb=Date.now()-(la.lastPullTime||p.start);if(!hb&&kb>qa.STALL_THRESHOLD){var lb=va();ma.error('stall',{lastSuccessTime:lb,rollupState:gb});hb=true;}var mb=Date.now()-db;if(la.state=='pull'&&mb>qa.JUMPSTART_THRESHOLD){db=null;ma.warn('jumpstart',{state:la.state,dormant:mb});la.enterState('init');}};ha(jb,10000);}function ya(){var db=Date.now(),eb=1;function fb(){ia(fb,eb*1000);var kb=la.state;if(kb=='idle'&&la.shouldIdle())return;ma.bump('conn_t',eb);if(kb=='pull')ma.bump('conn_t_pull',eb);}fb();var gb=[15,30,60,120,240],hb=false,ib=false;function jb(kb){ia(function(){ma.rate('pullenter_'+kb,hb);ma.rate('pullexit_'+kb,ib);},kb*1000);}while(gb.length)jb(gb.shift());h.subscribe(j.ON_ENTER_STATE,function(kb,lb){if(lb.state=='pull')hb=true;db=Date.now();});h.subscribe(j.ON_EXIT_STATE,function(kb,lb){if(lb.state!='pull'||!db)return;var mb='other';if(lb.status==j.OK){ib=true;mb='ok';}else if(lb.xhr&&lb.xhr.errorType){mb=/ar:(\w+)/.test(lb.xhr.errorType)&&RegExp.$1;}else if(/^sys_/.test(lb.status))return;var nb=(Date.now()-db)/1000;if(nb<0){return;}else if(nb>3600)nb=3600;ma.bump('conn_num');ma.bump('conn_exit',nb);ma.bump('conn_num_'+mb);ma.bump('conn_exit_'+mb,nb);});}function za(db){if(db){ua=0;ta={};}else ua++;}function ab(){if(!qa.stableDeviceId)return;var db={};db.sessionID=qa.sessionID;db.seq=qa.seq;db.estimatedReceived=qa.estimatedReceived;ja.setItem(ka,JSON.stringify(db));}function bb(db){if(!db)return false;db=db.trim();if(db.length===0)return false;try{var fb=JSON.parse(db),gb=function(ib){if(typeof(fb[ib])=="number")return fb[ib];ma.error("not an integer: "+ib+"="+fb[ib]);throw "NotAnInteger";};qa.seq=gb('seq');qa.estimatedReceived=gb('estimatedReceived');var hb=fb.sessionID;if(hb&&hb.length&&hb.trim()){qa.sessionID=hb;return true;}return false;}catch(eb){ma.error("unable to parse state: "+db);return false;}}la={state:'idle',nextState:null,proxyDown:false,lastPullTime:Date.now(),lastReportOnMisguidedMsgTime:Date.now(),heartbeats:[],setTestCallback:oa,backoff:false,init:function(db){this.init=function(){};this._logFantail('client initialized',j.FANTAIL_INFO);var eb=!!qa.use_sticky_session,fb=false;qa.stableDeviceId=false;if(eb&&ja){qa.stableDeviceId=true;var gb=true;for(var hb=0;hb<ja.length;hb++){var ib=ja.key(hb);if(ib.indexOf(ka)===0){fb=bb(ja.getItem(ib));gb=!fb;break;}}if(gb)ab();}this._logFantail('using session id: '+qa.sessionID+(fb?' [restored]':' [new]'),j.FANTAIL_INFO);ra.enabled=!!qa.watchdog_enabled;qa.watchdog=ra;if(typeof(ba)!='undefined'){ba.subscribe(function(){qa.userActive=Date.now();m.sendActivePing(qa);}.bind(this));}else ma.error('user_activity_undefined');v.register('ch',wa);var jb=this.getConfig('max_conn',2);qa.subdomain=l.allocate(jb);this._transportRate=new u(30000);var kb=(g.supportsCORS()&&!qa.forceIframe)?'CORSTransport':'IframeTransport';this.transport=new m[kb](this);if(db)this.enterState.apply(this,arguments);h.subscribe(s.DUMP_EVENT,function(event,mb){mb.transportRate=this._transportRate.tally();mb.transportType=kb;mb.transportVersion=2;}.bind(this));xa();ya();if(la.getConfig('tryStreaming')&&la.getConfig('host')&&g.supportsCORS()&&!qa.forceIframe){var lb=qa.MIN_INIT_PROBE_DELAY+Math.random()*qa.INIT_PROBE_DELAY_RANDOMIZE_RANGE;ia(this._probeTest,lb);}},configure:function(){var db=fa(arguments);ma.log('configure',db);db.forEach(ea.bind(null,qa));h.inform(j.ON_CONFIG,this);},getConfig:function(db,eb){return db in qa?qa[db]:eb;},getCompleteConfig:function(){return qa;},getWatchdog:function(){return ra;},isShutdown:function(){return this.state=='shutdown';},shouldIdle:function(){return !(z.isPageOwner()&&z.isOnline());},_sendIframeError:function(db){var eb=new i().setURI('/ajax/presence/reconnect.php').setData({reason:db,fb_dtsg:o.getToken()}).setOption('suppressErrorHandlerWarning',true).setOption('retries',1).setMethod('GET').setReadOnly(true).setAllowCrossPageTransition(true);eb.specifiesWriteRequiredParams()&&eb.send();},_getDelay:function(){var db=Math.min(qa.MIN_RETRY_INTERVAL*Math.pow(2,Math.max(0,ua-1)),qa.MAX_RETRY_INTERVAL);if(this.proxyDown&&'proxy_down_delay_millis' in qa)db=qa.proxy_down_delay_millis;this.proxyDown=false;return Math.floor(db*(1+Math.random()*.5));},enterState:function(){if(this._inEnterState)ma.warn('enterstate_recursion');this._inEnterState=true;try{this._enterState.apply(this,arguments);this._inEnterState=false;}catch(db){this._inEnterState=false;throw db;}},_enterState:function(db){if((db.indexOf('pull')===0||db.indexOf('ping')===0||db.indexOf('shutdown')===0)&&!!qa.active_config_refresh){var eb=Date.now(),fb=(eb-qa.reconnectOverrideTimeMillis)/1000;if('config_refresh_seconds' in qa&&qa.config_refresh_seconds>0&&fb>qa.config_refresh_seconds){db='reconnect';this._logFantail('forcing reconnect to refresh config'+' - this is normal behavior',j.FANTAIL_DEBUG);}}if(db.indexOf('reconnect')===0)qa.reconnectOverrideTimeMillis=Date.now();var gb=this.backoff?this._getDelay():0;this.backoff=false;var hb=fa(arguments);if(this.isShutdown()){this._logFantail('not executing state due to shutdown mode: '+db,j.FANTAIL_WARN);return;}if(db!='idle!'&&this.shouldIdle()){this._logFantail('forced idleness',j.FANTAIL_WARN);return;}sa++;qa.stateId=sa;clearTimeout(this._deferredTransition);this._deferredTransition=null;this.transport.enterState('idle');this.state='idle';this.nextState=null;if(/!$/.test(db)){var ib=this._transportRate.tally().timeAverage,jb=la.getConfig('MAX_CHANNEL_STATES_PER_SEC',1);if(ib>=jb){if(!this._throttled){this._throttled=true;ma.warn('throttled');}ma.bump('throttle');gb=1000/jb;}}else if(!(/#$/.test(db)))gb=this._getDelay();db=db.replace(/\W*$/,'');if(!pa[db]){this._logFantail('invalid state: '+db,j.FANTAIL_ERROR);throw new Error('invalid state:'+db);}var kb;if(gb<=0){kb={state:db};this._transportRate.add(1);this.state=db;var lb=this['_enter_'+this.state];if(lb){hb.shift();lb.apply(this,hb);}if(/init|idle|pull|ping/.test(this.state)){if(qa.streamingCapable&&/pull/.test(this.state))this.heartbeats=[];ra.transportEnteredState(db);ra.clientEnteredState(db);qa.is_offline=!n.isOnline();qa.capabilities=ca.getCapabilities();this._logFantail('entering transport state: '+this.state,j.FANTAIL_INFO);this.transport.enterState(this.state,qa);if(this.state=='ping'){kb.url=m.getURI(qa).toString();kb.port=qa.port||'undefined';}}}else{this.state='idle';this.nextState=db;kb={state:this.state,delay:gb,nextState:db};hb[0]=db+'#';this._deferredTransition=ia((function(){this._deferredTransition=null;this.enterState.apply(this,hb);}).bind(this),gb);}if(/pull/.test(db)){kb.client_id=qa.sessionID;kb.streaming=qa.inStreaming;}ma.log('enter_'+this.state,kb);h.inform(j.ON_ENTER_STATE,kb);},exitState:function(db,eb){var fb=db.stateId,gb=db.status;if((gb==j.SYS_TIMETRAVEL||gb==j.SYS_ONLINE||gb==j.SYS_NONOWNER||gb==j.SYS_OWNER)&&ra)ra.initialize();if(this.isShutdown()||fb<sa)return;var hb=fa(arguments),ib=this.state;hb[0]=db.status;var jb={state:ib,status:gb};if(/pull/.test(ib)){jb.client_id=qa.sessionID;jb.streaming=qa.inStreaming;}if(/ping/.test(ib)&&gb!=j.OK)jb.url=m.getURI(qa).toString();if(this.nextState)jb.nextState=this.nextState;if(eb&&eb.errorType){qa.lastRequestErrorReason=eb.errorType;jb.xhr=eb.toJSON?eb.toJSON():eb;if(eb.errorType==g.SERVICE_UNAVAILABLE){this._logFantail('got 5xx http status code, setting long delay',j.FANTAIL_ERROR);this.proxyDown=true;}delete jb.xhr.json;}else if(gb!=j.OK)qa.lastRequestErrorReason=gb;if(eb&&eb.json){if(eb.json.t)jb.t=eb.json.t;if(eb.json.reason)jb.reason=eb.json.reason;if(eb.json.seq)jb.seq=eb.json.seq;}ma.log('exit_'+ib,jb);h.inform(j.ON_EXIT_STATE,jb);var kb=this['_exit_'+ib];if(kb)gb=kb.apply(this,hb)||gb;if(gb!=j.OK){za();ta[ib]=(ta[ib]||0)+1;}var lb=pa[this.nextState||ib][gb]||pa._all[gb],mb=lb&&lb.replace(/!*$/,'');if(!mb){ma.error('terminal_transition',jb);this._shutdownHint=j.HINT_INVALID_STATE;lb='shutdown!';this._logFantail('entering shutdown state',j.FANTAIL_ERROR);}this._lastState=ib;this._lastStatus=gb;this.enterState(lb);},_processTransportData:function(db,eb){var fb=eb.json,gb=fb.t;if('s' in fb){fb.seq=fb.s;delete fb.s;}if(fb.u&&qa.user&&fb.u!=qa.user){ma.warn('misguided_msg',{user:qa.user,target:fb.u});this._reportProxyMisguidedMsg(fb.u,qa.user);return;}var hb=qa.seq;if('seq' in fb){qa.seq=fb.seq;w.doSync();}switch(gb){case 'continue':if(qa.inStreaming&&this.heartbeats.length<1){qa.streamingCapable=false;ma.log('switch_to_longpoll');ia(this._probeTest,qa.PROBE_DELAY);}za(true);if(!qa.inStreaming||qa.STREAMING_EXIT_STATE_ON_CONTINUE)this.exitState({status:j.OK,stateId:db});break;case 'refresh':case 'refreshDelay':this._logFantail('got refresh with reason: '+fb.reason,j.FANTAIL_INFO);this.exitState({status:'refresh_'+(fb.reason||0),stateId:db},eb);break;case 'backoff':this._logFantail('server told client to back off',j.FANTAIL_WARN);za();this.backoff=true;break;case 'lb':var ib=fb.lb_info;if(ib){qa.sticky_token=ib.sticky;if('pool' in ib){qa.sticky_pool=ib.pool;}else qa.host=ib.vip;if(g.supportsCORS()&&!qa.forceIframe){var jb=qa.subdomain===null?qa.host:(qa.subdomain+'-'+qa.host),kb=new da(jb,qa.port,qa.sticky_pool,qa.sticky_token,qa.uid,qa.viewer_uid,qa.profile,qa.sessionID,qa.capabilities);h.inform(j.RTI_SESSION,kb);}}else ma.error('bad lb info');break;case 'test_streaming':ia(this._probeTest,500);break;case 'fullReload':v.clear();ma.log('invalid_history');h.inform(j.ON_INVALID_HISTORY);za(true);this._logFantail('full reload incurred',j.FANTAIL_INFO);this.exitState({status:j.ERROR_MISSING,stateId:db},eb);break;case 'msg':var lb,mb,nb,ob;za(true);if('tr' in fb)qa.trace_id=fb.tr;mb=fb.ms;nb=qa.seq-mb.length;for(lb=0;lb<mb.length;lb++,nb++){qa.estimatedReceived++;if(nb>=hb){ob=mb[lb];if(ob.type){var pb=j.getArbiterType(ob.type);if(ob.type==='messaging'){var qb={type:'messaging',event:ob.event};if(ob.message){qb.inbox_unread=ob.unread_counts&&ob.unread_counts.inbox;qb.tid=ob.message.tid;qb.mid=ob.message.mid;this._logFantail('got message with id: '+ob.message.mid,j.FANTAIL_INFO);}ma.debug('message',qb);}else if(ob.type==='m_messaging'){ma.debug('message',{type:'m_messaging',tid:ob.tid,mid:ob.uuid});}else if(ob.type==='pages_messaging'){if(ob.unread_counts&&ob.unread_counts.inbox)h.inform(j.getArbiterType('pages_inbox_count_update'),{page_id:ob[t.VIEWER_FBID],inbox_unread:ob.unread_counts.inbox});}else if(ob.type==='skywalker'){pb=j.SKYWALKER;}else ma.debug('message',{type:ob.type});h.inform(pb,{obj:ob});}}else ma.warn('seq_regression',{seq:nb,last_seq:hb,messages:mb.length});}break;case 'heartbeat':if(qa.inStreaming){var rb=Date.now();if(this.heartbeats.length>0){var sb=rb-this.heartbeats[this.heartbeats.length-1];ma.log('heartbeat_interval',{client_id:qa.sessionID,interval:sb});}this.heartbeats.push(rb);}break;default:this._logFantail('got an unknown protocol message: '+gb,j.FANTAIL_ERROR);ma.error('unknown_msg_type',{type:gb});break;}ab();},_enter_init:function(){if(ta.init>=la.getConfig('MAX_INIT_FAILS',2))return setTimeout(this.exitState.bind(this,{status:j.ERROR_MAX,stateId:sa}),0);this._initTimer=ia(this.exitState.bind(this,{status:j.ERROR,stateId:sa},'timeout'),qa.IFRAME_LOAD_TIMEOUT);},_enter_reconnect:function(db){this._logFantail('entered reconnect with reason: '+db,j.FANTAIL_INFO);var eb=sa;if(!x.hasUserCookie()){this._logFantail('user has no cookie???',j.FANTAIL_WARN);ma.warn('no_user_cookie');setTimeout(function(){la._shutdownHint=j.HINT_AUTH;la.exitState({status:j.ERROR_SHUTDOWN,stateId:eb});},0);return;}var fb={reason:db,fb_dtsg:o.getToken()};if(r.token)fb.fb_isb=r.token;if(na)na(fb);var gb=new q('GET','/ajax/presence/reconnect.php',fb);gb.onSuccess=(function(){la.configure(gb.json);v.store();this.exitState({status:j.OK,stateId:eb});}).bind(this);gb.onError=(function(){var hb=gb.json&&gb.json.error;this._logFantail('reconnect error: '+gb.errorType,j.FANTAIL_ERROR);if(gb.errorType==g.TRANSPORT_ERROR||gb.errorType==g.PROXY_ERROR||gb.errorType==g.SERVICE_UNAVAILABLE)this._shutdownHint=j.HINT_CONN;if(hb&&hb==1356007){this._shutdownHint=j.HINT_MAINT;}else if(hb==1357001||hb==1357004||hb==1348009){this._shutdownHint=j.HINT_AUTH;}else this._shutdownHint=null;this.exitState({status:this._shutdownHint?j.ERROR_SHUTDOWN:j.ERROR,stateId:eb},gb);}).bind(this);gb.send();},_enter_shutdown:function(){h.inform(j.ON_SHUTDOWN,{reason:this._shutdownHint});if(!!qa.shutdown_recovery_enabled&&'shutdown_recovery_interval_seconds' in qa&&qa.shutdown_recovery_interval_seconds>0){var db=qa.shutdown_recovery_interval_seconds*1000;ia((function(){h.inform(j.ATTEMPT_RECONNECT);this.state='reconnect!';this.enterState('reconnect!');}).bind(this),db);}},_exit_init:function(db){if(this._initTimer)this._initTimer=clearTimeout(this._initTimer);if(db==j.ERROR_MAX)this._sendIframeError(j.reason_IFrameLoadGiveUp);},_exit_pull:function(db,eb){var fb=db==j.OK;ra.reportPullReturned(fb,this);if(fb){this.lastPullTime=Date.now();}else{var gb="exit status: "+db;if(eb&&eb.errorType)gb+=" ajax request error: "+eb.errorType;this._logFantail('pull failed with status: '+gb,j.FANTAIL_ERROR);}},_exit_ping:function(db){if(db==j.OK){var eb=Date.now()-(this.lastPullTime||p.start);if(eb>qa.STALL_THRESHOLD){this._logFantail('didnt complete a successful pull for too long',j.FANTAIL_ERROR);return j.ERROR_STALE;}}else this._logFantail('ping failed with status: '+db,j.FANTAIL_ERROR);},_reportProxyMisguidedMsg:function(db,eb){this._logFantail('misguided message to '+eb+' meant for '+db,j.FANTAIL_ERROR);var fb=Date.now();if(fb-this.lastReportOnMisguidedMsgTime<=qa.CHANNEL_PROXY_REPORTING_MIN_INTERVAL)return;this.lastReportOnMisguidedMsgTime=fb;var gb={received_uid:db,expected_uid:eb};if(qa.sticky_token)gb.sticky_token=qa.sticky_token;var hb=new aa('/err_misguided_msg').setDomain(qa.host+'.'+qa.domain).setPort(qa.port).setSecure(new aa(window.location.href).isSecure()).setQueryData(gb),ib=new g('GET',hb);if(g.supportsCORS())ib.xhr.withCredentials=true;ib.onSuccess=function(jb){};ib.onError=function(jb){};ib.onJSON=function(jb,kb){};ib.send();},_probeTest:function(){qa.streamingCapable=false;var db=[],eb={mode:'stream',format:'json'};if(qa.sticky_token)eb.sticky_token=qa.sticky_token;var fb=new aa('/probe').setDomain(qa.host+'.'+qa.domain).setPort(qa.port).setSecure(new aa(window.location.href).isSecure()).setQueryData(eb),gb=new g('GET',fb);gb.onJSON=function(hb,ib){if(hb&&hb.json&&hb.json.t==='heartbeat'){db.push(Date.now());if(db.length>=2){var jb=db[1]-db[0];if(jb>=qa.PROBE_HEARTBEATS_INTERVAL_LOW&&jb<=qa.PROBE_HEARTBEATS_INTERVAL_HIGH){qa.streamingCapable=true;ma.log('switch_to_streaming');}ma.log('probe_ok',{time:jb});}}};gb.onSuccess=function(hb){if(db.length!=2){qa.streamingCapable=false;ma.error('probe_error',{error:'beats.length = '+db.length});}};gb.onError=function(hb){qa.streamingCapable=false;ma.error('probe_error',hb);};ma.log('probe_request');gb.send();},_logFantail:function(db,eb){var fb=qa.fantail_queue_capacity||qa.FANTAIL_QUEUE_CAPACITY;if(!qa.fantail_enabled||qa.fantail_logs.length>fb)return;var gb='fantail queue size exceeded',hb=j.FANTAIL_WARN;if(qa.fantail_logs.length<fb){gb=db;hb=eb;}var ib=qa.fantail_logs.length,jb={};jb['time'+ib]=Date.now();jb['log'+ib]=gb;jb['severity'+ib]=hb;qa.fantail_logs.push(jb);}};e.exports=la;function cb(){if(k.channelConfig){la.configure(k.channelConfig);if(/shutdown/.test(k.state))la._shutdownHint=j[k.reason];la.init(k.state,k.reason);}}y.onAfterLoad(cb);},null);
__d("ChannelConnection",["Arbiter","copyProperties","ChatConfig","Run","SystemEvents","ChannelConstants","ChannelManager","JSLogger","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){b.__markCompiled&&b.__markCompiled();var p=n.create('channel_connection'),q=null,r=null,s=null,t=null,u=0,v=h(new g(),{CONNECTED:'chat-connection/connected',RECONNECTING:'chat-connection/reconnecting',SHUTDOWN:'chat-connection/shutdown',MUTE_WARNING:'chat-connection/mute',UNMUTE_WARNING:'chat-connection/unmute'});j.onBeforeUnload(function(){});function w(){if(r){clearTimeout(r);r=null;}}function x(){w();p.log('unmute_warning');v.inform(v.UNMUTE_WARNING);}function y(da){w();r=o(x,da);p.log('mute_warning',{time:da});v.inform(v.MUTE_WARNING);}function z(){if(s){clearTimeout(s);s=null;}}function aa(da,ea){z();if(da===l.ON_ENTER_STATE&&(ea.nextState||ea.state)==='pull'){if(t!==v.CONNECTED){p.log('connected');var fa=!t;t=v.CONNECTED;u=0;v.inform(v.CONNECTED,{init:fa});}}else if(da===l.ON_ENTER_STATE&&((ea.nextState||ea.state)==='ping'||(!ea.nextState&&ea.state==='idle'))){s=o(function(){var ga=null;if(!(ea.state==='idle'&&!ea.nextState))ga=(ea.delay||0);p.log('reconnecting',{delay:ga});if(v.disconnected())p.log('reconnecting_ui',{delay:ga});t=v.RECONNECTING;(ea.state==='idle')&&u++;if(u>1){v.inform(v.RECONNECTING,ga);}else if(!ea.nextState&&ea.state==='idle')aa(da,ea);},500);}else if(da===l.ON_SHUTDOWN){p.log('shutdown',{reason:ea.reason});t=v.SHUTDOWN;u=0;v.inform(v.SHUTDOWN,ea.reason);}}function ba(){if(m.isShutdown()){aa(l.ON_SHUTDOWN,m._shutdownHint);}else aa(l.ON_ENTER_STATE,{state:m.state,nextState:m.nextState,delay:0});}j.onAfterLoad(ba);h(v,{disconnected:function(){return t===v.SHUTDOWN||(t===v.RECONNECTING&&!r&&u>1);},isShutdown:function(){return t===v.SHUTDOWN;},reconnect:function(da){if(m.state==='ping'||m.isShutdown())return;p.log('reconnect',{now:da});v.inform(v.RECONNECTING,0);if(!!da){if(q!==null){clearTimeout(q);q=null;}m.enterState('ping!');}else if(!q)q=o(function(){m.enterState('ping!');q=null;},i.get('channel_manual_reconnect_defer_msec'));},unmuteWarning:x});function ca(){g.subscribe([l.ON_ENTER_STATE,l.ON_SHUTDOWN],aa);g.subscribe(l.ATTEMPT_RECONNECT,function(){if(v.disconnected())v.reconnect();});k.subscribe(k.TIME_TRAVEL,function(){v.reconnect();y(i.get('mute_warning_time_msec'));});j.onBeforeUnload(z,false);}j.onAfterLoad(ca);v.mockAfterLoad=function(){ba();ca();};e.exports=v;},null);
__d("TypingStates",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();var g={INACTIVE:0,TYPING:1,QUITTING:2};e.exports=g;},null);
__d("AvailableList",["Arbiter","ArbiterMixin","AsyncRequest","AvailableListConstants","BanzaiODS","Bootloader","ChannelConnection","ChannelConstants","ChatConfig","ChatVisibility","JSLogger","LastMobileActiveTimes","PresencePrivacy","PresenceStatus","ServerTime","ShortProfiles","TypingStates","copyProperties","debounceAcrossTransitions","emptyFunction"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z){b.__markCompiled&&b.__markCompiled();'use strict';k.setEntitySample('presence',.0001);var aa=x({},j,h);aa.subscribe([j.ON_AVAILABILITY_CHANGED,j.ON_UPDATE_ERROR],function(ja,ka){g.inform(ja,ka);});var ba=y(function(){aa.inform(j.ON_AVAILABILITY_CHANGED);},0);function ca(ja,ka,la,ma,na,oa){var pa=t.set(ja,ka,la,ma,na,oa);if(pa)ba();}function da(ja){var ka=ja.payload.availability||{};for(var la in ka)ca(la,ka[la].a,true,'mercury_tabs',ka[la].c,ka[la].p);}function ea(){ia&&ia.restart();}function fa(){ia&&ia.stop();}function ga(ja){var ka=aa.getDebugInfo(ja),la=(ka.presence==j.ACTIVE);new i('/ajax/mercury/tabs_presence.php').setData({target_id:ja,to_online:la,presence_source:ka.overlaySource,presence_time:ka.overlayTime}).setHandler(da).setErrorHandler(z).setAllowCrossPageTransition(true).send();}function ha(ja,ka){ka.chat_config=o.getDebugInfo();ka.available_list_debug_info={};t.getAvailableIDs().forEach(function(la){ka.available_list_debug_info[la]=aa.getDebugInfo(la);});ka.available_list_poll_interval=aa._poller&&aa._poller.getInterval();}var ia;l.loadModules(["PresencePoller"],function(ja){ia=new ja(function(event){aa.inform(event);});ia.start();});x(aa,{get:function(ja){return t.get(ja);},updateForID:function(ja){ga(ja);},shouldUpdateForID:function(ja){if(o.get('avoid_available_list_updates',false))return t.getCapabilities(ja)===0;return true;},getWebChatNotification:function(){return ia&&ia.getWebChatNotification();},isUserIdle:function(){return ia&&ia.getIsUserIdle();},isReady:function(){return !!ia;},set:function(ja,ka,la,ma,na){ca(ja,ka,true,la,ma,na);},update:function(){ia&&ia.forceUpdate();},isIdle:function(ja){return aa.get(ja)==j.IDLE;},getDebugInfo:function(ja){var ka=t.getDebugInfo(ja),la=v.getNow(ja);if(la)ka.name=la.name;return ka;}});g.subscribe(q.DUMP_EVENT,ha);g.subscribe('chat-visibility/go-online',ea);g.subscribe('chat-visibility/go-offline',fa);s.subscribe(['privacy-changed','privacy-availability-changed','privacy-user-presence-response'],ba);m.subscribe([m.CONNECTED,m.RECONNECTING,m.SHUTDOWN,m.MUTE_WARNING,m.UNMUTE_WARNING],ba);g.subscribe(n.getArbiterType('buddylist_overlay'),function(ja,ka){var la={},ma=ka.obj.overlay;for(var na in ma){aa.set(na,ma[na].a,ma[na].s||'channel',ma[na].vc,ma[na].p);if(ma[na].la)la[na]=ma[na].la;}r.update(la);});g.subscribe([n.getArbiterType('typ'),n.getArbiterType('ttyp')],function(ja,ka){var la=ka.obj;if(la.st===w.TYPING){var ma=la.from;if(p.isOnline()){k.bumpEntityKey('presence','stale_presence_check_typing');var na=t.get(ma);if(na!=j.ACTIVE){var oa=r.get(ma)*1000,pa=u.get();if(!oa){k.bumpEntityKey('presence','no_detailed_presence_typing');}else if(pa-oa>5*60*1000){var qa='stale_presence_typing',ra=pa-oa;if(ra<10*60*1000){qa+='600';}else if(ra<60*60*1000)qa+='3600';k.bumpEntityKey('presence',qa);}}}aa.set(ma,j.ACTIVE,'channel-typing');}});g.subscribe(n.getArbiterType('messaging'),function(ja,ka){if(!p.isOnline())return;var la=ka.obj;if(la.message&&la.message.timestamp&&la.message.sender_fbid){var ma=u.get(),na=la.message.timestamp;if(ma-na<2*60*1000){k.bumpEntityKey('presence','stale_presence_check');var oa=la.message.sender_fbid,pa=t.get(oa);if(pa==j.ACTIVE)return;var qa=r.get(oa)*1000;if(!qa){k.bumpEntityKey('presence','no_detailed_presence');}else if(na-qa>5*60*1000){var ra='stale_presence',sa=na-qa;if(sa<10*60*1000){ra+='600';}else if(sa<60*60*1000)ra+='3600';k.bumpEntityKey('presence',ra);}}}});a.AvailableList=e.exports=aa;},null);
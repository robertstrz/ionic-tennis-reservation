/*!CK:291289544!*//*1433872983,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["nHUJQ"]); }

__d("MercuryActionStatus",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={UNSENT:0,SUCCESS:1,UNCONFIRMED:3,FAILED_UNKNOWN_REASON:4,UNABLE_TO_CONFIRM:5,RESENT:6,RESENDING:7,ERROR:10};},null);
__d("MercuryActionType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={LOG_MESSAGE:"ma-type:log-message",USER_GENERATED_MESSAGE:"ma-type:user-generated-message",CHANGE_READ_STATUS:"ma-type:change_read_status",MARK_THREAD_SEEN:"ma-type:mark_thread_seen",CHANGE_MUTE_SETTINGS:"ma-type:change-mute-settings",SEND_MESSAGE:"ma-type:send-message",UPDATE_ACTION_ID:"ma-type:update-action-id",DELETE_MESSAGES:"ma-type:delete-messages",MARK_MESSAGES_SPAM:"ma-type:mark-messages-spam",DELETE_THREAD:"ma-type:delete-thread",CHANGE_ARCHIVED_STATUS:"ma-type:change-archived-status",CHANGE_FOLDER:"ma-type:change-folder",ADD_PARTICIPANTS:"ma-type:add-participants",CANCEL_ATTACHMENT_PLACEHOLDER:"ma-type:cancel-attachment-placeholder",CONFIRM_ATTACHMENT_PLACEHOLDER:"ma-type:confirm-attachment-placeholder",UNPIN_THREAD:"ma-type:unpin-thread",CHANGE_FLAG:"ma-type:change_flag"};},null);
__d("MercuryAPIArgsSource",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={CHAT:"chat",JEWEL:"jewel",MERCURY:"mercury",MERCURYSYNC:"mercury_sync",WEBMESSENGER:"web_messenger",MESSENGER:"messenger"};},null);
__d("MercuryAttachmentContentType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={PHOTO:"attach:image",VIDEO:"attach:video",MUSIC:"attach:music",VOICE:"attach:voice",TEXT:"attach:text",MSWORD:"attach:ms:word",MSXLS:"attach:ms:xls",MSPPT:"attach:ms:ppt",ORION:"attach:orion",SHOERACK_INVITATION:"attach:shoerackinvite",UNKNOWN:"attach:unknown"};},null);
__d("MercuryAttachmentType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={ERROR:"error",FILE:"file",PHOTO:"photo",STICKER:"sticker",SHARE:"share",UNKNOWN:"unknown",VIDEO:"video",ANIMATED_IMAGE:"animated_image"};},null);
__d("MercuryAudioType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={AudioClip:"fb_voice_message",VoiceMessageWithTranscript:"fb_voice_message_with_transcript"};},null);
__d("MercuryErrorType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={SERVER:1,TRANSPORT:2,TIMEOUT:3};},null);
__d("MercuryGlobalActionType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={MARK_ALL_READ:"mga-type:mark-all-read"};},null);
__d("MercuryLogMessageType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={SUBSCRIBE:"log:subscribe",UNSUBSCRIBE:"log:unsubscribe",VIDEO_CALL:"log:video-call",PHONE_CALL:"log:phone-call",THREAD_NAME:"log:thread-name",THREAD_IMAGE:"log:thread-image",SERVER_ERROR:"log:error-msg",LIVE_LISTEN:"log:live-listen",WALLPAPER:"log:wallpaper",ORION:"log:orion",SWITCH_TO_WORK:"log:switch",PAGE_REPLY:"log:page-reply",GENERIC_ADMIN_TEXT:"log:generic-admin-text"};},null);
__d("MercuryPayloadSource",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={UNKNOWN:"unknown",CLIENT_CHANNEL_MESSAGE:"client_channel_message",CLIENT_SEND_MESSAGE:"client_send_message",CLIENT_CHANGE_ARCHIVED_STATUS:"client_change-archived_status",CLIENT_CHANGE_FOLDER:"client_change_folder",CLIENT_CHANGE_MUTE_SETTINGS:"client_change_mute_settings",CLIENT_CHANGE_READ_STATUS:"client_change_read_status",CLIENT_MARK_THREAD_SEEN:"client_mark_thread_seen",CLIENT_ADD_PARTICIPANTS:"client_add_participants",CLIENT_FETCH_PARTICIPANTS:"client_fetch_participants",CLIENT_DELETE_MESSAGES:"client_delete_messages",CLIENT_MARK_MESSAGES_SPAM:"client_mark_messages_spam",CLIENT_DELETE_THREAD:"client_delete_thread",CLIENT_HANDLE_ERROR:"client_handle_error",CLIENT_UNPIN_THREAD:"client_unpin_thread",CLIENT_CHANGE_FLAG:"client_change_flag",SERVER_INITIAL_DATA:"server_initial_data",SERVER_SEND_MESSAGE:"server_send_message",SERVER_CONFIRM_MESSAGES:"server_confirm_messages",SERVER_CHANGE_ARCHIVED_STATUS:"server_change_archived_status",SERVER_CHANGE_READ_STATUS:"server_change_read_status",SERVER_MARK_FOLDER_READ:"server_mark_folder_read",SERVER_MARK_SEEN:"server_mark_seen",SERVER_FETCH_PARTICIPANTS:"server_fetch_participants",SERVER_FETCH_THREAD_INFO:"server_fetch_thread_info",SERVER_FETCH_THREADLIST_INFO:"server_fetch_threadlist_info",SERVER_STANDALONE_NOTIFICATIONS:"server_standalone_notifications",SERVER_THREAD_SYNC:"server_thread_sync",SERVER_TAB_PRESENCE:"server_tab_presence",SERVER_UNREAD_THREADS:"server_unread_threads",SERVER_SEARCH:"server_search",SERVER_CHANGE_FLAG:"server_change_flag"};},null);
__d("MercurySourceType",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={CHAT_ORCA:"source:chat:orca",CHAT_IPHONE:"source:chat:iphone",CHAT_JABBER:"source:chat:jabber",CHAT_MEEBO:"source:chat:meebo",CHAT_WEB:"source:chat:web",CHAT_TEST:"source:chat:test",CHAT_FORWARD_DIALOG:"source:chat:forward",CHAT:"source:chat",EMAIL:"source:email",EVENT_MESSAGE_BLAST:"source:event_message_blast",GIGABOXX_API:"source:gigaboxx:api",GIGABOXX_BLAST:"source:gigaboxx:blast",GIGABOXX_EMAIL_REPLY:"source:gigaboxx:emailreply",GIGABOXX_MOBILE:"source:gigaboxx:mobile",GIGABOXX_WAP:"source:gigaboxx:wap",GIGABOXX_WEB:"source:gigaboxx:web",LEIA:"source:leia",MESSENGER_WEB:"source:messenger:web",SAM_UFI:"source:sam:ufi",SHARE_DIALOG:"source:share:dialog",SEND_PLUGIN:"source:sendplugin",SMS:"source:sms",TEST:"source:test",TITAN_WAP:"source:titan:wap",TITAN_M_BASIC:"source:titan:m_basic",TITAN_M_FREE:"source:titan:m_free_basic",TITAN_M_JAPAN:"source:titan:m_japan",TITAN_M_MINI:"source:titan:m_mini",TITAN_M_TOUCH:"source:titan:m_touch",TITAN_M_APP:"source:titan:m_app",TITAN_M_TABLET:"source:titan:m_tablet",TITAN_M_ZERO:"source:titan:m_zero",TITAN_M_TALK:"source:titan:m_talk",TITAN_WEB:"source:titan:web",TITAN_FACEWEB_ANDROID:"source:titan:faceweb_android",TITAN_FACEWEB_BUFFY:"source:titan:faceweb_buffy",TITAN_FACEWEB_IPAD:"source:titan:faceweb_ipad",TITAN_FACEWEB_IPHONE:"source:titan:faceweb_iphone",TITAN_FACEWEB_UNKNOWN:"source:titan:faceweb_unknown",TITAN_API:"source:titan:api",TITAN_API_MOBILE:"source:titan:api_mobile",TITAN_ORCA:"source:titan:orca",TITAN_EMAIL_REPLY:"source:titan:emailreply",MOBILE:"source:mobile",PAGE_PLATFORM_API:"source:page_platform_api",UNKNOWN:"source:unknown",WEB:"source:web",HELPCENTER:"source:helpcenter",NEW_SHARE_DIALOG:"source:share:dialog:new",PAID_PROMOTION:"source:paid_promotion",BUFFY_SMS:"source:buffy:sms",WEBRTC_MOBILE:"source:webrtc:mobile",MESSENGER_COMMERCE:"source:messenger:commerce"};},null);
__d("MercuryThreadMode",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={EMAIL_ORIGINATED:1,TITAN_ORIGINATED:2,OBJECT_ORIGINATED:3};},null);
__d("MessagingTag",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={GROUPS:"groups",UNREAD:"unread",FLAGGED:"flagged",ACTION_ARCHIVED:"action:archived",INBOX:"inbox",OTHER:"other",PENDING:"pending",EVENT:"event",SENT:"sent",SMS_MUTE:"sms_mute",SPAM:"spam",UPDATES:"broadcasts_inbox",BCC:"header:bcc",FILTERED_CONTENT:"filtered_content",UNAVAILABLE_ATTACHMENT:"unavailable_attachment",ARCHIVED:"archived",EMAIL:"email",VOICEMAIL:"voicemail",SPAM_SPOOFING:"spam:spoofing",SPOOF_WARNING:"MTA:spoof_warning",SMS_TAG_ROOT:"SMSShortcode:",APP_ID_ROOT:"app_id:",DOMAIN_AUTH_PASS:"MTA:dmarc:pass",DOMAIN_AUTH_FAIL:"MTA:dmarc:fail",MTA_SYSTEM_MESSAGE:"MTA:system_message",EMAIL_MESSAGE:"source:email"};},null);
__d("PageMessageEnumTag",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();e.exports={FLAG:"flag"};},null);
__d("ChatImpressionLogger",["AsyncSignal","requireWeak","ChatConfig","ChatVisibility","Poller","PresencePrivacy","PresenceStatus","debounceAcrossTransitions","copyProperties"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){b.__markCompiled&&b.__markCompiled();var p=null;h(['AvailableList'],function(v){return p=v;});var q=null;function r(){if(!q)return '';return q.getCachedSortedList().toString();}function s(){if(!q||!p)return '';var v=[],w=q.getCachedSortedList();for(var x=0;x<w.length;x++)v[x]=p.get(w[x]);return v.toString();}function t(v){v.setURI('/ajax/chat/imps_logging.php').setData({list_availability:s(),sorted_list:r(),source:'periodical_imps'});}var u={init:function(v){q=v;var w=i.get('chat_impression_logging_periodical',0);if(w){var x=i.get('periodical_impression_logging_config.interval'),y=new k({interval:x,setupRequest:t,clearOnQuicklingEvents:false,dontStart:true});l.subscribe('privacy-user-presence-changed',n(function(){if(j.isOnline()){y.start();}else y.stop();}));}this.init=function(){};},logImpression:function(v,w,x){var y=i.get('chat_impression_logging_with_click'),z={list_availability:y?s():'',sorted_list:y?r():'',source:v,target:w,target_presence:m.get(w),viewport_width:document.body.clientWidth};new g('/ajax/chat/ct.php',o(z,x)).send();}};e.exports=u;},null);
__d("ChatWelcomeMessage",["ImmutableObject"],function(a,b,c,d,e,f,g){b.__markCompiled&&b.__markCompiled();'use strict';function h(){this.$ChatWelcomeMessage0={};}h.prototype.setWelcomeMessage=function(j,k,l){this.$ChatWelcomeMessage0[j]=new g({timestamp:Date.now(),thread_id:j,author:k,body:l});};h.prototype.getWelcomeMessage=function(j){return this.$ChatWelcomeMessage0[j];};var i=new h();e.exports=i;},null);
__d("MercuryIDs",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();var g={isValid:function(h){if(!h||typeof h!=='string')return false;return (/^\w{3,12}:/.test(h));},isValidThreadID:function(h){if(!g.isValid(h))return false;var i=g.tokenize(h);switch(i.type){case 'user':case 'group':case 'thread':case 'root':case 'pending':return true;default:return false;}},tokenize:function(h){if(!this.isValid(h))throw ("bad_id_format "+h);var i=h.indexOf(':');return {type:h.substr(0,i),value:h.substr(i+1)};},getUserIDFromParticipantID:function(h){if(!this.isValid(h))throw ("bad_id_format "+h);var i=g.tokenize(h),j=i.type,k=i.value;if(j!='fbid')return null;return k;},getParticipantIDFromUserID:function(h){if(isNaN(h))throw ("Not a user ID: "+h);return 'fbid:'+h;},getUserIDFromThreadID:function(h){if(!this.isCanonical(h))return null;return this.tokenize(h).value;},getThreadIDFromUserID:function(h){return 'user:'+h;},getThreadIDFromParticipantID:function(h){var i=this.getUserIDFromParticipantID(h);return i?this.getThreadIDFromUserID(i):null;},getParticipantIDFromFromThreadID:function(h){return this.getParticipantIDFromUserID(this.getUserIDFromThreadID(h)||'');},isCanonical:function(h){return this.isValid(h)&&this.tokenize(h).type==='user';},isGroupChat:function(h){return this.isValid(h)&&this.tokenize(h).type!=='user';}};e.exports=g;},null);
__d("MercuryAssert",["MercuryIDs"],function(a,b,c,d,e,f,g){b.__markCompiled&&b.__markCompiled();e.exports={isParticipantID:function(h){if(!g.isValid(h))throw ("bad_participant_id "+h);},allParticipantIDs:function(h){h.forEach(this.isParticipantID);},isUserParticipantID:function(h){var i=g.tokenize(h);if(i.type!='fbid')throw ("bad_user_id "+h);},isEmailParticipantID:function(h){var i=g.tokenize(h);if(i.type!='email')throw ("bad_email_id "+h);},allThreadID:function(h){h.forEach(this.isThreadID);},isThreadID:function(h){if(!g.isValid(h))throw ("bad_thread_id "+h);}};},null);
__d("MercuryAttachment",["MercuryAttachmentContentType","MercuryAttachmentType","MercuryAudioType"],function(a,b,c,d,e,f,g,h,i){b.__markCompiled&&b.__markCompiled();'use strict';var j={getAttachIconClass:function(k){switch(k){case g.PHOTO:return 'MercuryPhotoIcon';case g.VIDEO:return 'MercuryVideoIcon';case g.MUSIC:return 'MercuryMusicIcon';case g.VOICE:return 'MercuryVoiceIcon';case g.TEXT:return 'MercuryTextIcon';case g.MSWORD:return 'MercuryMSWordIcon';case g.MSXLS:return 'MercuryMSXLSIcon';case g.MSPPT:return 'MercuryMSPPTIcon';}return 'MercuryDefaultIcon';},getAttachIconClassByMime:function(k){if(k.startsWith('image')){return 'MercuryPhotoIcon';}else if(k.startsWith('video')){return 'MercuryVideoIcon';}else if(k.startsWith('audio')){return 'MercuryMusicIcon';}else if(k.startsWith('text/plain')){return 'MercuryTextIcon';}else return 'MercuryDefaultIcon';},getAttachTypeByMime:function(k){if(k.startsWith('image')){return g.PHOTO;}else if(k.startsWith('video')){return g.VIDEO;}else if(k.startsWith('audio')){return g.MUSIC;}else if(k.startsWith('text/plain')){return g.TEXT;}else return g.UNKNOWN;},convertRaw:function(k){var l=[];for(var m=0;m<k.length;m++){var n=k[m];if(n.attach_type===h.PHOTO){l.push(n);}else if(n.filename){var o=j.getAttachTypeByMime(n.filetype),p={};p.attach_type=h.FILE;p.name=n.filename;p.icon_type=o;p.url='';l.push(p);}}return l;},get:function(k){var l=[];if(k.attachments){l=k.attachments;}else if(k.raw_attachments)l=this.convertRaw(k.raw_attachments);if(!(k.attachments&&k.attachments.length>0)){if(k.sticker_id)return l.concat([{attach_type:h.STICKER}]);if(k.preview_attachments&&k.preview_attachments.length>0)return l.concat(k.preview_attachments);}return l;},isVoiceMessage:function(k){return (k===i.AudioClip||k===i.VoiceMessageWithTranscript);},resizeContain:function(k,l){var m=k.width/k.height,n=l.width/l.height;if(n<m){return {width:Math.ceil(Math.min(k.height*n,l.width)),height:Math.ceil(Math.min(k.height,l.height))};}else return {width:Math.ceil(Math.min(k.width,l.width)),height:Math.ceil(Math.min(k.width/n,l.height))};}};e.exports=j;},null);
__d("MercurySingletonMixin",["CurrentUser"],function(a,b,c,d,e,f,g){b.__markCompiled&&b.__markCompiled();var h={_getInstances:function(){if(!this._instances)this._instances={};return this._instances;},get:function(){return this.getForFBID(g.getID());},getForFBID:function(i){var j=this._getInstances();if(!j[i])j[i]=new this(i);return j[i];}};e.exports=h;},null);
__d("FBID",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();'use strict';var g={isUser:function(h){return h<2.2e+09||(h>=1e+14&&h<=100099999989999)||(h>=8.9e+13&&h<=89999999999999)||(h>=6.000001e+13&&h<=60000019999999);}};e.exports=g;},null);
__d("MercuryThreadIDMap",["KeyedCallbackManager","MercuryAssert","MercuryIDs","MercurySingletonMixin"],function(a,b,c,d,e,f,g,h,i,j){b.__markCompiled&&b.__markCompiled();'use strict';function k(l){this.$MercuryThreadIDMap0=l;this.$MercuryThreadIDMap1=new g();this.$MercuryThreadIDMap2=new g();this.$MercuryThreadIDMap3=new g();}k.prototype.setServerToClientID=function(l,m){this.$MercuryThreadIDMap1.setResource(l,m);};k.prototype.getClientIDFromServerIDNow=function(l){return this.$MercuryThreadIDMap1.getResource(l);};k.prototype.setFBIDToClientID=function(l,m){this.$MercuryThreadIDMap2.setResource(l,m);this.$MercuryThreadIDMap3.setResource(m,l);};k.prototype.getClientIDFromFBIDNow=function(l){return this.$MercuryThreadIDMap2.getResource(l);};k.prototype.getClientIDFromFBID=function(l,m){this.$MercuryThreadIDMap2.executeOrEnqueue(l,m);d(['MercuryServerRequests'],function(n){n.getForFBID(this.$MercuryThreadIDMap0).ensureThreadIsFetched(l);}.bind(this));};k.prototype.setClientIDToFBID=function(l,m){this.$MercuryThreadIDMap3.setResource(l,m);this.$MercuryThreadIDMap2.setResource(m,l);};k.prototype.getFBIDFromClientIDNow=function(l){return this.$MercuryThreadIDMap3.getResource(l);};k.prototype.getFBIDFromClientID=function(l,m){h.isThreadID(l);var n=this.$MercuryThreadIDMap3.executeOrEnqueue(l,m);d(['MercuryServerRequests'],function(o){var p=this.$MercuryThreadIDMap3.getUnavailableResources(n),q=i.tokenize(l);if(p.length&&q.type!='root')o.getForFBID(this.$MercuryThreadIDMap0).fetchThreadData(p);}.bind(this));};k.prototype.hasClientIDForFBID=function(l){return !!this.getClientIDFromFBIDNow(l);};k.prototype.convertThreadIDIfAvailable=function(l){var m=this.getClientIDFromFBIDNow(l);if(m===(void 0)){return l;}else return m;};k.prototype.canLinkExternally=function(l){h.isThreadID(l);var m=i.tokenize(l);return (m.type=='user')||!!this.getFBIDFromClientIDNow(l);};Object.assign(k,j);e.exports=k;},null);
__d("MercuryMessageClientState",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();var g={DO_NOT_SEND_TO_SERVER:'do_not_send_to_server',SEND_TO_SERVER:'send_to_server'};e.exports=g;},null);
__d("MercurySendErrorLogger",["Banzai","BanzaiLogger"],function(a,b,c,d,e,f,g,h){b.__markCompiled&&b.__markCompiled();var i=h.create({retry:true}),j=g.isEnabled('mercury_send_error_logging'),k={log:function(l){if(!j)return;var m={message_id:l.message_id,timestamp_client:Date.now(),error_type:l.error_data.type,error_code:l.error_data.code,error_description:l.error_data.description,is_transient:l.error_data.is_transient};i.log('MercurySendErrorLoggerConfig',m);}};e.exports=k;},null);
__d("MercuryServerSendMessageQueueSimulatedError",["AsyncRequest","AsyncResponse","copyProperties"],function(a,b,c,d,e,f,g,h,i){b.__markCompiled&&b.__markCompiled();var j=9999,k={create:function(l){var m=new g(this.endpoint_uri).setData({message_batch:[l],client:this.client}),n=new h(m,{});i(n,{error:j,silentError:false,transientError:true,request:m});return n;}};e.exports=k;},null);
__d("MercuryServerSendMessageQueue",["BanzaiODS","LogHistory","MercuryLoggingHelper","MercuryServerRequestsConfig","MercuryServerDispatcher","MercuryServerSendMessageQueueSimulatedError"],function(a,b,c,d,e,f,g,h,i,j,k,l){b.__markCompiled&&b.__markCompiled();var m='/ajax/mercury/send_messages.php',n=h.getInstance('mercury_server_send_message_queue');function o(p,q,r,s){"use strict";this.sender_id=p;this.queue_id=q;this.$MercuryServerSendMessageQueue0=r.success_handler;this.$MercuryServerSendMessageQueue1=r.error_handler;this.$MercuryServerSendMessageQueue2=r.transport_error_handler;this.$MercuryServerSendMessageQueue3=r.timeout_handler;this.client=s;var t=null;if(j.msgrRegion)t={name:'X-MSGR-Region',value:j.msgrRegion};var u={};u[m]={request_user_id:this.sender_id,endpoint_id:this.queue_id,mode:k.IMMEDIATE,customHeader:t,handler:this.handleSuccess.bind(this),error_handler:this.handleError.bind(this),transport_error_handler:this.handleTransportError.bind(this),timeout:r.timeout,timeout_handler:this.handleTimeout.bind(this),connection_retries:r.connection_retries};k.registerEndpoints(u);this.pending_message=null;this.queue=[];}o.prototype.enqueue=function(p){"use strict";this.queue.push(p);this.$MercuryServerSendMessageQueue5();};o.prototype.$MercuryServerSendMessageQueue5=function(){"use strict";if(this.pending_message||!this.queue.length){if(this.pending_message)this.$MercuryServerSendMessageQueue6();return;}this.pending_message=this.queue.shift();k.trySend(m,{message_batch:[this.pending_message],client:this.client},null,this.sender_id,this.queue_id);};o.prototype.$MercuryServerSendMessageQueue7=function(){"use strict";while(this.queue.length)this.$MercuryServerSendMessageQueue8(this.queue.shift());};o.prototype.$MercuryServerSendMessageQueue8=function(p){"use strict";this.$MercuryServerSendMessageQueue1(l.create(p));n.error('mark_as_failed',{fbid:this.sender_id,queue_id:this.queue_id,message:i.obfuscateMessage(p)});};o.prototype.handleSuccess=function(p,q){"use strict";this.$MercuryServerSendMessageQueue0(p,q);this.pending_message=null;this.$MercuryServerSendMessageQueue5();};o.prototype.handleError=function(p){"use strict";this.$MercuryServerSendMessageQueue1(p);this.$MercuryServerSendMessageQueue7();this.pending_message=null;};o.prototype.handleTransportError=function(p){"use strict";this.$MercuryServerSendMessageQueue2(p);this.$MercuryServerSendMessageQueue7();this.pending_message=null;};o.prototype.handleTimeout=function(p){"use strict";this.$MercuryServerSendMessageQueue3(p);this.$MercuryServerSendMessageQueue7();this.pending_message=null;};o.prototype.$MercuryServerSendMessageQueue6=function(){"use strict";n.debug('maybe_send_next_pending_message',{fbid:this.sender_id,queue_id:this.queue_id,pending_message:i.obfuscateMessage(this.pending_message),queue:this.queue.map(function(q){return i.obfuscateMessage(q);})});var p='send_queue.delayed.queue_length.'+this.queue.length.toString();g.bumpEntityKey('chat.web',p);};e.exports=o;},null);
__d("MercuryServerSendMessageQueueRouter",["BanzaiODS","LogHistory","Map","MercuryServerSendMessageQueue","MercurySingletonMixin"],function(a,b,c,d,e,f,g,h,i,j,k){b.__markCompiled&&b.__markCompiled();var l=h.getInstance('mercury_server_send_message_queue_router'),m='chat.web.send_queue_router';g.setEntitySample(m,.1);function n(o){"use strict";this.fbid=o;this.queues=new i();}n.prototype.enqueue=function(o,p,q,r){"use strict";if(!this.queues.has(o)){this.queues.set(o,new j(this.fbid,o,p,q));l.debug('added queue',{fbid:this.fbid,queue_id:o});g.bumpEntityKey(m,'new_queue');}this.queues.get(o).enqueue(r);};Object.assign(n,k);e.exports=n;},null);
__d("PagesMessengerThreadUtils",["PageMessageEnumTag"],function(a,b,c,d,e,f,g){b.__markCompiled&&b.__markCompiled();var h={isFlagThread:function(i){if(!i)return false;return i.page_thread_info?i.page_thread_info.flagged:false;},isPageSpecficFilter:function(i){if(i===g.FLAG)return true;return false;}};e.exports=h;},null);
__d("MercuryPageServerRequests",["MercuryAPIArgsSource","MercuryAssert","MercuryServerRequests","PageMessageEnumTag","PagesMessengerThreadUtils","MercuryServerDispatcher"],function(a,b,c,d,e,f,g,h,i,j,k,l){b.__markCompiled&&b.__markCompiled();var m=g.MERCURY;for(var n in i)if(i.hasOwnProperty(n))p[n]=i[n];var o=i===null?null:i.prototype;p.prototype=Object.create(o);p.prototype.constructor=p;p.__superConstructor__=i;function p(q){"use strict";i.call(this,q);var r={'/pages/messaging/thread_tag/add/':{request_user_id:q,mode:l.BATCH_SUCCESSIVE,batch_function:this.$MercuryPageServerRequests0,handler:function(s,t){return this.__handleUpdate(s,t);}.bind(this)},'/pages/messaging/thread_tag/remove/':{request_user_id:q,mode:l.BATCH_SUCCESSIVE,batch_function:this.$MercuryPageServerRequests0,handler:function(s,t){return this.__handleUpdate(s,t);}.bind(this)},'/pages/messaging/thread_tag/list/':{request_user_id:q,mode:l.IMMEDIATE,handler:function(s,t){return this.__handleUpdate(s,t);}.bind(this)}};l.registerEndpoints(r);}p.prototype.$MercuryPageServerRequests0=function(q,r){"use strict";var s=q?q.tag_name:r.tag_name,t=q?q.thread_ids:[],u=r?r.thread_ids:[],v=t.concat(u),w={tag_name:s,thread_ids:v};return w;};p.prototype.addThreadFlag=function(q,r){"use strict";h.isThreadID(q);this.__threadIDMap.getFBIDFromClientID(q,function(s){var t={thread_ids:[s],tag_name:j.FLAG};this.__sendRequest('/pages/messaging/thread_tag/add/',t);}.bind(this));};p.prototype.fetchThreadlistInfo=function(q,r,s,t,u){"use strict";if(k.isPageSpecficFilter(t)){u=u||m;var v={folder:s,tag_name:t,offset:q,limit:r};this.__sendRequest('/pages/messaging/thread_tag/list/',v);return;}o.fetchThreadlistInfo.call(this,q,r,s,t,u);};p.prototype.removeThreadFlag=function(q,r){"use strict";h.isThreadID(q);this.__threadIDMap.getFBIDFromClientID(q,function(s){var t={thread_ids:[s],tag_name:j.FLAG};this.__sendRequest('/pages/messaging/thread_tag/remove/',t);}.bind(this));};p.prototype.toString=function(){"use strict";return 'MercuryPageServerRequests';};e.exports=p;},null);
__d("MercuryServerRequestSingletonMixin",["CurrentUser","FBID"],function(a,b,c,d,e,f,g,h){b.__markCompiled&&b.__markCompiled();var i={_getInstances:function(){if(!this._instances)this._instances={};return this._instances;},get:function(){return this.getForFBID(g.getID());},getForFBID:function(j){var k=this._getInstances();if(!k[j])if(h.isUser(j)){k[j]=new this(j);}else{var l;d(['MercuryPageServerRequests'],function(m){l=new m(j);});k[j]=l;}return k[j];}};e.exports=i;},null);
__d("MercuryMessageIDs",["KeyedCallbackManager"],function(a,b,c,d,e,f,g){b.__markCompiled&&b.__markCompiled();var h=new g(),i={getServerIDs:function(j,k){var l=j.filter(function(n){return n.indexOf('mail.projektitan.com')!==-1;}),m=function(n){var o=j.map(function(p){return n[p]?n[p]:p;});k(o);};return h.executeOrEnqueue(l,m);},addServerID:function(j,k){h.setResource(j,k);}};e.exports=i;},null);
__d("MessagingReliabilityLogger",["PresenceUtil","MercuryServerDispatcher","MessagingReliabilityLoggerInitialData","isEmpty","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k){b.__markCompiled&&b.__markCompiled();var l='/ajax/mercury/client_reliability.php',m=60000;function n(t,u){var v={app:i.app,categories:JSON.stringify(t)};if(!j(u))v.extra=JSON.stringify(u);return v;}function o(t,u,v,w){if(t[u]===(void 0))t[u]={};if(t[u][v]===(void 0))t[u][v]=0;t[u][v]+=w;}function p(t,u,v,w){if(t[u]===(void 0))t[u]={};if(t[u][v]===(void 0))t[u][v]=[];for(var x=0;x<w.length;++x)t[u][v].push(w[x]);}function q(t,u){if((t&&!t.categories)||(u&&!u.categories))return;var v=t?JSON.parse(t.categories):{},w=t&&t.extra?JSON.parse(t.extra):{},x=JSON.parse(u.categories),y=u.extra?JSON.parse(u.extra):{};for(var z in x){var aa=x[z],ba=y[z];for(var ca in aa){o(v,z,ca,aa[ca]);if(ba!==(void 0)){var da=ba[ca];if(da!==(void 0))p(w,z,ca,da);}}}return n(v,w);}var r={};r[l]={mode:h.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR,batch_function:q};h.registerEndpoints(r);var s={addEntry:function(t,u,v){if(!i.enabled)return;var w={};o(w,t,u,1);var x={};if(v!==(void 0))p(x,t,u,[v]);h.trySend(l,n(w,x));}};(function t(){s.addEntry('page_event','active',g.getSessionID());k(t,m);})();e.exports=s;},null);
__d("MercuryServerSendMessageQueueOptions",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();function g(h,i,j,k,l,m){"use strict";this.success_handler=h;this.error_handler=i;this.transport_error_handler=j;this.timeout_handler=k;this.timeout=l;this.connection_retries=m;}e.exports=g;},null);
__d("MercuryThreadInformer",["ArbiterMixin","LogHistory","MercuryAssert","MercuryLoggingHelper","MercurySingletonMixin","copyProperties","mapObject","mixin"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){b.__markCompiled&&b.__markCompiled();'use strict';var o=h.getInstance('mercury_informer'),p=n(g);for(var q in p)if(p.hasOwnProperty(q))s[q]=p[q];var r=p===null?null:p.prototype;s.prototype=Object.create(r);s.prototype.constructor=s;s.__superConstructor__=p;function s(u){this.$MercuryThreadInformer0=u;this.$MercuryThreadInformer1={};this.$MercuryThreadInformer2={};this.$MercuryThreadInformer3={};this.$MercuryThreadInformer4=false;this.$MercuryThreadInformer5=false;this.$MercuryThreadInformer6=false;this.$MercuryThreadInformer7={};this.$MercuryThreadInformer8={};this.$MercuryThreadInformer9={};this.$MercuryThreadInformera=0;}s.prototype.updatedThread=function(u){this.$MercuryThreadInformer2[u]=true;this.$MercuryThreadInformerb();};s.prototype.deletedThread=function(u){this.$MercuryThreadInformer1[u]=true;this.$MercuryThreadInformerb();};s.prototype.updatedThreadlist=function(){this.$MercuryThreadInformer4=true;this.$MercuryThreadInformerb();};s.prototype.updatedUnseenState=function(){this.$MercuryThreadInformer5=true;this.$MercuryThreadInformerb();};s.prototype.updatedUnreadState=function(){this.$MercuryThreadInformer6=true;this.$MercuryThreadInformerb();};s.prototype.changedThreadReadState=function(u,v,w){if(!this.$MercuryThreadInformer3[u]||this.$MercuryThreadInformer3[u].timestamp<w)this.$MercuryThreadInformer3[u]={mark_as_read:v,timestamp:w};this.$MercuryThreadInformerb();};s.prototype.receivedMessage=function(u){i.isThreadID(u.thread_id);var v=u.thread_id;if(!this.$MercuryThreadInformer7[v])this.$MercuryThreadInformer7[v]=[];this.$MercuryThreadInformer7[v].push(u);this.updatedThread(v);};s.prototype.reorderedMessages=function(u,v){this.$MercuryThreadInformer8[u]={source:v};this.$MercuryThreadInformerb();};s.prototype.updatedMessage=function(u,v,w){if(!this.$MercuryThreadInformer9[u])this.$MercuryThreadInformer9[u]={};this.$MercuryThreadInformer9[u][v]={source:w};this.updatedThread(u);};s.prototype.synchronizeInforms=function(u){this.$MercuryThreadInformera++;try{u();}catch(v){throw v;}finally{this.$MercuryThreadInformera--;this.$MercuryThreadInformerb();}};s.prototype.listen=function(u,v){return this.subscribe('threads-updated',function(w,x){if(x[u])v(u);});};s.prototype.$MercuryThreadInformerb=function(){if(!this.$MercuryThreadInformera){var u=this.$MercuryThreadInformer1,v=this.$MercuryThreadInformer2,w=this.$MercuryThreadInformer3,x=this.$MercuryThreadInformer4,y=this.$MercuryThreadInformer5,z=this.$MercuryThreadInformer6,aa=this.$MercuryThreadInformer7,ba=this.$MercuryThreadInformer8,ca=this.$MercuryThreadInformer9;this.$MercuryThreadInformer1={};this.$MercuryThreadInformer2={};this.$MercuryThreadInformer3={};this.$MercuryThreadInformer4=false;this.$MercuryThreadInformer5=false;this.$MercuryThreadInformer6=false;this.$MercuryThreadInformer7={};this.$MercuryThreadInformer8={};this.$MercuryThreadInformer9={};var da=Object.keys(v);if(da.length||x)this.inform('threadlist-updated',da);if(da.length)this.$MercuryThreadInformerc('threads-updated',v);for(var ea in w){this.$MercuryThreadInformerc('thread-read-changed',w);break;}for(ea in u){this.$MercuryThreadInformerc('threads-deleted',u);break;}if(y)this.$MercuryThreadInformerc('unseen-updated',null);if(z)this.$MercuryThreadInformerc('unread-updated',null);for(ea in aa){this.$MercuryThreadInformerc('messages-received',aa);break;}for(ea in ba){this.$MercuryThreadInformerc('messages-reordered',ba);break;}for(ea in ca){this.$MercuryThreadInformerc('messages-updated',ca);break;}}};s.prototype.$MercuryThreadInformerc=function(u,v){t(u,v);this.inform(u,v);};function t(u,v){var w=v;if(u=='messages-received')w=m(w,function(x){return x.map(function(y){return j.obfuscateMessage(y);});});o.debug(u,w);}l(s,k);e.exports=s;},null);
__d("MercuryServerRequests",["Arbiter","ArbiterMixin","AsyncResponse","BanzaiLogger","ChannelConstants","CurrentUser","FBID","LogHistory","MercuryActionStatus","MercuryActionType","MercuryAPIArgsSource","MercuryAssert","MercuryThreadIDMap","MercuryErrorType","MercuryGlobalActionType","MercuryIDs","MercuryLoggingHelper","MercuryLogMessageType","MercuryMessageClientState","MercuryPayloadSource","MercurySendErrorLogger","MercuryServerRequestsConfig","MercuryServerSendMessageQueueRouter","MercuryServerRequestSingletonMixin","MercurySourceType","MercuryThreadlistConstants","MercuryMessageIDs","MessagingConfig","MessagingReliabilityLogger","MessagingTag","MercuryServerDispatcher","MercuryServerSendMessageQueueOptions","MercuryThreadInformer","copyProperties","createObjectFrom","errorCode","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa,qa){b.__markCompiled&&b.__markCompiled();'use strict';var ra=n.getInstance('mercury_server'),sa=q.MERCURY;function ta(mb,nb){if(nb)mb._lastActionTimestamp=Math.max(mb._lastActionTimestamp,nb);}function ua(mb,nb){var ob=nb.thread_fbid;if(nb.canonical_fbid)ob=nb.canonical_fbid;var pb=mb.__threadIDMap.getClientIDFromFBIDNow(ob);if(!pb){if(nb.canonical_fbid){pb='user:'+nb.canonical_fbid;}else if(nb.root_message_threading_id)pb='root:'+nb.root_message_threading_id;pb=pb||'thread:'+ob;if(ob)ob=ob.toString();mb.__threadIDMap.setClientIDToFBID(pb,ob);mb._newlyAddedClientIDs[ob]=pb;if(nb.thread_id){mb.__threadIDMap.setServerToClientID(nb.thread_id,pb);mb._newlyAddedClientIDs[nb.thread_id]=pb;}}nb.thread_id=pb;}function va(mb){return mb.thread_fbid||mb.thread_id||mb.client_thread_id;}function wa(mb,nb,ob){if(nb.action_type!=p.SEND_MESSAGE)return;var pb=nb.thread_fbid;if(nb.other_user_fbid)pb=nb.other_user_fbid;var qb=nb.client_thread_id;if(!qb)qb=mb.__threadIDMap.getClientIDFromFBIDNow(pb);var rb=null;if(qb)rb=v.tokenize(qb).type;ya(mb,nb,ob==='success');if(nb.status===o.ERROR){aa.log(nb);}else ia.addEntry('send_'+rb,ob,pb+','+nb.message_id);}function xa(mb){return mb.getError()?'_'+mb.getError():'';}function ya(mb,nb,ob){if(Math.floor(Math.random()*20)===0)if(nb.client_message_id in mb._sentMessagesTimestamp){var pb=mb._sentMessagesTimestamp[nb.client_message_id],qb=Date.now()-pb,rb=nb.client_thread_id;if(!rb)rb=mb.__threadIDMap.getClientIDFromFBIDNow(nb.thread_fbid);j.log('WebMessagingLatencyLoggerConfig',{has_attachment:nb.attachments&&nb.attachments.length>0,latency:qb,is_canonical:!v.isGroupChat(rb),send_successful:ob,source:'client'});}}function za(mb,nb){var ob=null;switch(nb.status){case o.SUCCESS:ob='success';break;case o.FAILED_UNKNOWN_REASON:ob='confirmed_error';break;case o.UNABLE_TO_CONFIRM:ob='confirm_error';break;default:return;}wa(mb,nb,ob);}function ab(mb,nb){(nb.threads||[]).forEach(function(xb){ua(mb,xb);delete mb._fetchingThreads[xb.thread_id];var yb=mb.__threadIDMap.getFBIDFromClientIDNow(xb.thread_id);delete mb._fetchingThreads[yb];ta(mb,xb.timestamp);});(nb.ordered_threadlists||[]).forEach(function(xb){var yb=xb.thread_fbids||[];yb=yb.concat(xb.other_user_fbids||[]);xb.thread_ids=yb.map(function(zb){return mb.__threadIDMap.getClientIDFromFBIDNow(zb);});});if(nb.pinned_threads&&nb.pinned_threads.thread_fbids)nb.pinned_threads.thread_fbids=nb.pinned_threads.thread_fbids.map(function(xb){return mb.__threadIDMap.getClientIDFromFBIDNow(xb);});nb.actions=nb.actions||[];nb.actions.forEach(function(xb){za(mb,xb);var yb=xb.thread_fbid;if(xb.other_user_fbid)yb=xb.other_user_fbid;if(xb.status&&xb.status!=o.SUCCESS&&!yb){xb.thread_id=xb.client_thread_id;return;}if(xb.action_type==p.SEND_MESSAGE&&xb.client_thread_id&&yb){var zb=yb.toString(),ac=xb.client_thread_id;mb.__threadIDMap.setClientIDToFBID(ac,zb);mb._newlyAddedClientIDs[zb]=ac;}var bc=xb.thread_id;if(yb){xb.thread_id=mb.__threadIDMap.hasClientIDForFBID(yb)?mb.__threadIDMap.getClientIDFromFBIDNow(yb):null;}else if(xb.client_thread_id)xb.thread_id=xb.client_thread_id;if(!xb.thread_id)xb.server_thread_id=bc;if(!nb.payload_source||!nb.payload_source.startsWith('server'))ta(mb,xb.timestamp);});if(nb.end_of_history){var ob=[];for(var pb=0;pb<nb.end_of_history.length;pb++){var qb=nb.end_of_history[pb];if(qb.type=='user'){ob.push('user:'+qb.fbid);}else if(qb.type=='thread'&&mb.__threadIDMap.hasClientIDForFBID(qb.fbid))ob.push(mb.__threadIDMap.getClientIDFromFBIDNow(qb.fbid));}nb.end_of_history=ob;}if(nb.roger){var rb={};for(var sb in nb.roger){var tb=mb.__threadIDMap.getClientIDFromFBIDNow(sb);if(tb){var ub=nb.roger[sb];rb[tb]={};for(var vb in ub)if(ub.hasOwnProperty(vb)){var wb=v.getParticipantIDFromUserID(vb);rb[tb][wb]=ub[vb];}}}nb.roger=rb;}}function bb(mb){if(mb._pendingUpdates&&mb._pendingUpdates.length){var nb=mb._pendingUpdates[0];mb._pendingUpdates=mb._pendingUpdates.slice(1);mb.handleUpdate(nb);}}function cb(mb,nb){var ob=na({},mb),pb;if(nb.threads){if(!ob.threads)ob.threads={};for(pb in nb.threads)ob.threads[pb]=Object.keys(oa((ob.threads[pb]||[]).concat(nb.threads[pb])));}if(nb.messages){if(!ob.messages)ob.messages={};for(pb in nb.messages){if(!ob.messages[pb])ob.messages[pb]={};for(var qb in nb.messages[pb])if(ob.messages[pb][qb]){ob.messages[pb][qb]=hb(ob.messages[pb][qb],nb.messages[pb][qb]);}else ob.messages[pb][qb]=nb.messages[pb][qb];}}ob.client=mb.client||nb.client;return ob;}function db(mb,nb){var ob=na(oa(mb.folders,true),oa(nb.folders,true)),pb=mb.client||nb.client;return {folders:Object.keys(ob),client:pb};}function eb(mb,nb){for(var ob in nb)if(mb[ob]&&typeof mb[ob]==='object'){mb[ob]=hb(mb[ob],nb[ob]);}else if(nb[ob]&&typeof nb[ob]==='object'){var pb={};na(pb,nb[ob]);mb[ob]=pb;}return mb;}function fb(mb,nb){var ob=Object.assign({},mb.ids,nb.ids),pb=mb.client||nb.client;return {ids:ob,client:pb};}function gb(mb,nb){return nb;}function hb(mb,nb){var ob=mb.offset<nb.offset?mb.offset:nb.offset,pb=mb.offset+mb.limit,qb=nb.offset+nb.limit,rb=(pb>qb)?pb:qb,sb=rb-ob;return {offset:ob,limit:sb};}function ib(mb,nb){var ob=mb.client||nb.client,pb={ids:{},client:ob};na(pb.ids,mb.ids);na(pb.ids,nb.ids);return pb;}function jb(mb,nb){var ob={},pb,qb=mb.client||nb.client;delete mb.client;delete nb.client;for(pb in mb)na(ob,oa(mb[pb],pb));for(pb in nb)na(ob,oa(nb[pb],pb));var rb={client:qb};for(var sb in ob){pb=ob[sb];if(!rb[pb])rb[pb]=[];rb[pb].push(sb);}return rb;}function kb(mb,nb){var ob=mb.client||nb.client,pb=oa(mb.ids,true),qb=oa(nb.ids,true),rb=na(pb,qb);return {ids:Object.keys(rb),client:ob};}function lb(mb){this._fbid=mb;this._lastActionTimestamp=0;this._pendingUpdates=[];this._fetchingThreads={};this._newlyAddedClientIDs={};this._sentMessagesTimestamp={};this.__threadIDMap=s.getForFBID(this._fbid);this._sendMessageQueueOptions=new la(function(nb,ob){return this.__handleUpdate(nb,ob);}.bind(this),function(nb){return this._handleSendMessageError(nb);}.bind(this),function(nb){return this._handleSendMessageTransportError(nb);}.bind(this),function(nb){return this._handleSendMessageTimeout(nb);}.bind(this),ba.sendMessageTimeout,ha.SEND_CONNECTION_RETRIES);this._registerEndpoints();}na(lb.prototype,h,{fetchThreadlistInfo:function(mb,nb,ob,pb,qb){ob=ob||ja.INBOX;qb=qb||sa;var rb=pb?ka.IMMEDIATE:null,sb={client:qb};sb[ob]={offset:mb,limit:nb,filter:pb};this.__sendRequest('/ajax/mercury/threadlist_info.php',sb,rb);},fetchPinnedThreads:function(){this.__sendRequest('/mercury/pinned_threads/',{});},fetchUnseenThreadIDs:function(mb,nb){nb=nb||sa;this.fetchThreadlistInfo(fa.RECENT_THREAD_OFFSET,fa.JEWEL_THREAD_COUNT,mb,null,nb);},fetchUnreadThreadIDs:function(mb,nb){nb=nb||sa;this.__sendRequest('/ajax/mercury/unread_threads.php',{folders:[mb],client:nb});},fetchMissedMessages:function(mb,nb){nb=nb||sa;var ob={last_action_timestamp:this._lastActionTimestamp,folders:mb,client:nb};ob.last_action_timestamp=this._lastActionTimestamp;this.__sendRequest('/ajax/mercury/thread_sync.php',ob);},fetchThreadData:function(mb,nb){nb=nb||sa;r.allThreadID(mb);var ob={threads:{},client:nb},pb=[],qb=[];mb.forEach(function(sb){if(this._fetchingThreads[sb])return;this._fetchingThreads[sb]=true;var tb=this.__threadIDMap.getFBIDFromClientIDNow(sb),ub=v.tokenize(sb);if(ub.type=='user'){pb.push(ub.value);ob.threads.user_ids=pb;}else if(ub.type=='thread'){if(tb){qb.push(tb);}else qb.push(ub.value);ob.threads.thread_fbids=qb;}else if(ub.type=='root'){if(tb){qb.push(tb);ob.threads.thread_fbids=qb;}}else if(ub.type!='pending')throw new Error('Unknown thread type',ub);}.bind(this));this.inform("fetch-thread-data",ob);for(var rb in ob.threads){this.__sendRequest('/ajax/mercury/thread_info.php',ob);break;}},ensureThreadIsFetched:function(mb,nb){nb=nb||sa;if(!this.__threadIDMap.getClientIDFromFBIDNow(mb)&&!this._fetchingThreads[mb]){this._fetchingThreads[mb]=true;this.__sendRequest('/ajax/mercury/thread_info.php',{threads:{thread_fbids:[mb]},client:nb});}},fetchThreadMessages:function(mb,nb,ob,pb,qb,rb){r.isThreadID(mb);rb=rb||sa;var sb,tb,ub=v.tokenize(mb),vb=this.__threadIDMap.getFBIDFromClientIDNow(mb),wb=false;if(vb){sb=vb;tb=(ub.type=='user')?'user_ids':'thread_fbids';}else{sb=ub.value;switch(ub.type){case 'user':tb='user_ids';wb=true;break;case 'thread':tb='thread_fbids';break;}}var xb={messages:{},threads:{},client:rb};if(tb){xb.messages[tb]={};xb.messages[tb][sb]={offset:nb,timestamp:pb,limit:ob};if(wb)xb.threads[tb]=[sb];this.__sendRequest('/ajax/mercury/thread_info.php',xb,qb);}else this.__threadIDMap.getFBIDFromClientID(mb,function(yb){xb.messages.thread_fbids={};xb.messages.thread_fbids[yb]={offset:nb,timestamp:pb,limit:ob};this.__sendRequest('/ajax/mercury/thread_info.php',xb,qb);}.bind(this));},handleThreadInfoError:function(mb){var nb=mb.getRequest().getData(),ob=[];if(nb.messages){for(var pb in nb.messages.thread_fbids)ob.push(this._createServerErrorLogMessage(this.__threadIDMap.getClientIDFromFBIDNow(pb)));for(var qb in nb.messages.user_ids)ob.push(this._createServerErrorLogMessage('user:'+qb));for(var rb in nb.messages.group_ids)ob.push(this._createServerErrorLogMessage('group:'+rb));}if(ob.length)this.handleUpdate({actions:ob,from_client:true,payload_source:z.CLIENT_CHANNEL_MESSAGE});if(nb.threads&&(nb.threads.user_ids||nb.threads.group_ids||nb.threads.thread_ids)){var sb=5,tb=true;if(!nb.retry_count){nb.retry_count=0;if(nb.messages)delete nb.messages;}else if(nb.retry_count>=sb){tb=false;(nb.threads.thread_ids||[]).forEach(function(vb){if(vb in this._fetchingThreads)delete this._fetchingThreads[vb];}.bind(this));}if(tb){var ub=nb.retry_count*1000;qa(function(){ra.log('retry_thread',nb);this.__sendRequest('/ajax/mercury/thread_info.php',nb);}.bind(this),ub);nb.retry_count++;}}},markFolderAsRead:function(mb){this.__sendRequest('/ajax/mercury/mark_folder_as_read.php',{folder:mb});var nb=[{action_type:u.MARK_ALL_READ,action_id:null,folder:mb}];this.handleUpdate({global_actions:nb,from_client:true,payload_source:z.CLIENT_CHANGE_READ_STATUS});},changeThreadReadStatus:function(mb,nb,ob){r.isThreadID(mb);this.__threadIDMap.getFBIDFromClientID(mb,function(pb){var qb={ids:{},source:ob};qb.ids[pb]=nb;this.__sendRequest('/ajax/mercury/change_read_status.php',qb);}.bind(this));},changeThreadArchivedStatus:function(mb,nb,ob){r.isThreadID(mb);this.__threadIDMap.getFBIDFromClientID(mb,function(pb){var qb={ids:{},source:ob};qb.ids[pb]=nb;this.__sendRequest('/ajax/mercury/change_archived_status.php',qb);}.bind(this));},changeThreadFolder:function(mb,nb){r.isThreadID(mb);this.__threadIDMap.getFBIDFromClientID(mb,function(ob){var pb={};pb[nb]=[ob];this.__sendRequest('/ajax/mercury/move_thread.php',pb);}.bind(this));},changeMutingOnThread:function(mb,nb){r.isThreadID(mb);this.__threadIDMap.getFBIDFromClientID(mb,function(ob){this.__sendRequest('/ajax/mercury/change_mute_thread.php',{thread_fbid:ob,mute_settings:nb,payload_source:sa});}.bind(this));},markThreadSpam:function(mb,nb){r.isThreadID(mb);this.__threadIDMap.getFBIDFromClientID(mb,function(ob){this.__sendRequest('/ajax/mercury/mark_spam.php',{id:ob,source:nb});}.bind(this));},markMessagesSpam:function(mb,nb){ga.getServerIDs(nb||[],function(ob){this.__sendRequest('/ajax/mercury/mark_spam_messages.php',{message_ids:ob});}.bind(this));},unmarkThreadSpam:function(mb,nb){r.isThreadID(mb);this.__threadIDMap.getFBIDFromClientID(mb,function(ob){this.__sendRequest('/ajax/mercury/unmark_spam.php',{id:ob,source:nb});}.bind(this));},deleteThread:function(mb,nb){r.isThreadID(mb);this.__threadIDMap.getFBIDFromClientID(mb,function(ob){var pb={ids:[ob],source:nb};this.__sendRequest('/ajax/mercury/delete_thread.php',pb);}.bind(this));},unpinThread:function(mb){r.isThreadID(mb);this.__threadIDMap.getFBIDFromClientID(mb,function(nb){this.__sendRequest('/mercury/unpin_thread/',{id:nb});}.bind(this));},deleteMessages:function(mb,nb){ga.getServerIDs(nb||[],function(ob){this.__sendRequest('/ajax/mercury/delete_messages.php',{message_ids:ob});}.bind(this));},sendDeliveryReceipts:function(mb){ga.getServerIDs(mb||[],function(nb){this.__sendRequest('/ajax/mercury/delivery_receipts.php',{message_ids:nb});}.bind(this));},sendNewMessage:function(mb,nb){nb=nb||sa;if(!mb.client_state||mb.client_state==y.SEND_TO_SERVER){var ob=v.tokenize(mb.thread_id),pb=ob.type,qb=na({},mb);if((pb=='root'&&ob.value==qb.message_id)||(pb=='user')){qb.client_thread_id=qb.thread_id;qb.thread_id=null;this._sendNewMessageToServer(qb,nb);}else this.__threadIDMap.getFBIDFromClientID(qb.thread_id,function(rb){ob=v.tokenize(qb.thread_id);if(ob.type=='user'){qb.other_user_fbid=ob.values;}else qb.thread_fbid=rb;qb.thread_id=null;this._sendNewMessageToServer(qb);}.bind(this));}},_sendNewMessageToServer:function(mb,nb){g.inform(k.ATTEMPT_RECONNECT);nb=nb||sa;this._sentMessagesTimestamp[mb.message_id]=Date.now();ca.getForFBID(this._fbid).enqueue(va(mb),this._sendMessageQueueOptions,nb,mb);},requestMessageConfirmation:function(mb,nb){nb=nb||sa;var ob={},pb={};for(var qb in mb){var rb=this.__threadIDMap.getFBIDFromClientIDNow(qb);if(rb){ob[rb]=mb[qb];}else{var sb=mb[qb];for(var tb=0;tb<sb.length;tb++)pb[sb[tb]]=qb;}}var ub=Object.keys(ob),vb=Object.keys(pb);if(ub.length||vb.length)this.__sendRequest('/ajax/mercury/confirm_messages.php',{thread_message_map:ob,local_messages:pb,client:nb});},handleMessageConfirmError:function(mb){var nb=mb.getRequest().getData().thread_message_map,ob=mb.getRequest().getData().local_messages;if(!nb&&!ob)return;var pb=[];for(var qb in nb){var rb=nb[qb];rb.forEach(function(ub){pb.push({action_type:p.SEND_MESSAGE,client_message_id:ub,message_id:ub,client_thread_id:null,thread_fbid:qb,status:o.UNABLE_TO_CONFIRM});});}for(var sb in ob){var tb=ob[sb];pb.push({action_type:p.SEND_MESSAGE,client_message_id:sb,message_id:sb,client_thread_id:tb,thread_fbid:null,status:o.UNABLE_TO_CONFIRM});}if(pb.length)this.handleUpdate({actions:pb,payload_source:z.CLIENT_HANDLE_ERROR});},markSeen:function(){var mb=this._lastActionTimestamp;this.__sendRequest('/ajax/mercury/mark_seen.php',{seen_timestamp:mb});},handleRoger:function(mb){var nb=mb.thread_fbid?this.__threadIDMap.getClientIDFromFBIDNow(mb.thread_fbid):v.getThreadIDFromUserID(mb.reader);if(nb){var ob=v.getParticipantIDFromUserID(mb.reader),pb={};pb[nb]={};pb[nb][ob]=mb.time;this.inform('update-roger',pb);}},handleUpdateWaitForThread:function(mb,nb,ob){ob=ob||sa;var pb=this.__threadIDMap.getClientIDFromFBIDNow(nb);if(pb){this.handleUpdate(mb);return;}this.__threadIDMap.getClientIDFromFBID(nb,function(){this._pendingUpdates.push(mb);}.bind(this));if(!this._fetchingThreads[nb]){this._fetchingThreads[nb]=true;var qb={threads:{thread_fbids:[nb]},client:ob};if(m.isUser(nb))qb={threads:{user_ids:[nb]},client:ob};this.__sendRequest('/ajax/mercury/thread_info.php',qb);}},handleUpdate:function(mb){var nb=[];if(mb&&mb.threads)for(var ob=0;ob<mb.threads.length;ob++){if(!mb.threads[ob].snippet_attachments)continue;for(var pb=0;pb<mb.threads[ob].snippet_attachments.length;pb++)if(mb.threads[ob].snippet_attachments[pb].share_xhp){nb.push({i:ob,j:pb,xhp:mb.threads[ob].snippet_attachments[pb].share_xhp});mb.threads[ob].snippet_attachments[pb].share_xhp="HTMLDivElement not shown: object contains circular "+"reference, which was breaking JSON.stringify. "+"Look at MercuryServerRequests.handleUpdate";}}var qb={actions:[],threads:[]};if(mb){if(mb.actions)qb.actions=mb.actions.map(function(ub){return w.obfuscateMessage(ub);});if(mb.threads)qb.threads=mb.threads.map(function(ub){return w.obfuscateThread(ub);});}var rb=na({},mb,qb),sb=mb.payload_source;if(sb!==z.CLIENT_CHANGE_READ_STATUS&&sb!==z.CLIENT_MARK_THREAD_SEEN)ra.debug('update:'+sb,{payload:rb,from_client:mb.from_client});for(var tb=0;tb<nb.length;tb++)mb.threads[nb[tb].i].snippet_attachments[nb[tb].j].share_xhp=nb[tb].xhp;for(tb in mb){ma.getForFBID(this._fbid).synchronizeInforms(function(){if(!mb.from_client){ab(this,mb);this.inform('payload-preprocessed',mb);}this.inform('update-thread-ids',this._newlyAddedClientIDs);this._newlyAddedClientIDs={};this.inform('update-participants',mb);this.inform('update-threads',mb);this.inform('update-unread',mb);this.inform('update-threadlist',mb);this.inform('update-pinned-threads',mb);this.inform('update-messages',mb);this.inform('update-unseen',mb);this.inform('update-typing-state',mb);this.inform('update-roger',mb.roger);this.inform('model-update-completed',null);bb(this);}.bind(this));break;}},_handleSendMessageErrorCommon:function(mb,nb,ob,pb){ra.debug('handle_send_message_error_common',{reliability_error_status:ob,request_error_status:nb});var qb=mb.getData(),rb=qb.message_batch,sb=rb.map(function(ub){var vb={action_type:p.SEND_MESSAGE,thread_fbid:ub.thread_fbid,client_message_id:ub.message_id,message_id:ub.message_id,client_thread_id:ub.client_thread_id,status:nb,error_data:pb};return vb;});sb.forEach(function(ub){wa(this,ub,ob);},this);var tb={actions:sb,payload_source:z.CLIENT_HANDLE_ERROR};this.handleUpdate(tb);},handleSendMessageError:function(mb){var nb=mb.getPayload(),ob=null,pb=null;if(nb&&nb.error_payload){ob=o.UNCONFIRMED;pb='send_error';}else{ob=o.ERROR;pb='request_error'+xa(mb);}var qb=mb.error;if(qb===1404102)i.verboseErrorHandler(mb);var rb=/<.*>/.test(mb.getErrorDescription())?mb.getErrorSummary():mb.getErrorDescription();this._handleSendMessageErrorCommon(mb.getRequest(),ob,pb,{type:t.SERVER,code:mb.getError(),description:rb,is_transient:mb.isTransient()});},handleSendMessageTransportError:function(mb){this._handleSendMessageErrorCommon(mb.getRequest(),o.ERROR,'transport_error'+xa(mb),{type:t.TRANSPORT,code:mb.getError(),is_transient:true});},handleSendMessageTimeout:function(mb){this._handleSendMessageErrorCommon(mb,o.ERROR,'transport_timeout',{type:t.TIMEOUT,is_transient:true});},getLastActionTimestamp:function(){return this._lastActionTimestamp;},_createServerErrorLogMessage:function(mb){return {action_type:p.LOG_MESSAGE,thread_id:mb,message_id:mb,timestamp:Date.now(),timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:ea.UNKNOWN,log_message_type:x.SERVER_ERROR,log_message_data:{}};},_getForAsyncRequest:function(mb){var nb=mb.getData(),ob=nb.request_user_id?nb.request_user_id:l.getID();return lb.getForFBID(ob);},__handleUpdate:function(mb,nb){this._getForAsyncRequest(nb).handleUpdate(mb);},_handleThreadInfoError:function(mb){var nb=this._getForAsyncRequest(mb.getRequest());nb.handleThreadInfoError(mb);},_handleSendMessageError:function(mb){var nb=this._getForAsyncRequest(mb.getRequest());nb.handleSendMessageError(mb);},_handleSendMessageTransportError:function(mb){var nb=this._getForAsyncRequest(mb.getRequest());nb.handleSendMessageTransportError(mb);},_handleSendMessageTimeout:function(mb){var nb=this._getForAsyncRequest(mb);nb.handleSendMessageTimeout(mb);},_handleMessageConfirmError:function(mb){var nb=this._getForAsyncRequest(mb.getRequest());nb.handleMessageConfirmError(mb);},_registerEndpoints:function(){var mb=null;if(ba.msgrRegion)mb={name:'X-MSGR-Region',value:ba.msgrRegion};var nb={'/ajax/mercury/thread_sync.php':{request_user_id:this._fbid,mode:ka.IDEMPOTENT,customHeader:mb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/ajax/mercury/thread_info.php':{request_user_id:this._fbid,mode:ka.BATCH_DEFERRED_MULTI,customHeader:mb,batch_function:cb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this),error_handler:function(ob){return this._handleThreadInfoError(ob);}.bind(this)},'/ajax/mercury/mark_folder_as_read.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,customHeader:mb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/ajax/mercury/change_read_status.php':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE,customHeader:mb,batch_function:fb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/ajax/mercury/mark_seen.php':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE,customHeader:mb,batch_function:gb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/ajax/mercury/confirm_messages.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,customHeader:mb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this),error_handler:function(ob){return this._handleMessageConfirmError(ob);}.bind(this)},'/ajax/mercury/threadlist_info.php':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE_UNIQUE,customHeader:mb,batch_function:eb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/ajax/mercury/mark_spam.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,customHeader:mb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/ajax/mercury/mark_spam_messages.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,customHeader:mb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/ajax/mercury/unmark_spam.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,customHeader:mb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/ajax/mercury/unread_threads.php':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE_UNIQUE,customHeader:mb,batch_function:db,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/ajax/chat/settings.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,customHeader:mb},'/ajax/mercury/change_archived_status.php':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE,customHeader:mb,batch_function:ib,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/ajax/mercury/delete_thread.php':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE,customHeader:mb,batch_function:kb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/ajax/mercury/delete_messages.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,customHeader:mb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/ajax/mercury/delivery_receipts.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,customHeader:mb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/ajax/mercury/move_thread.php':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE,customHeader:mb,batch_function:jb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/ajax/mercury/change_mute_thread.php':{request_user_id:this._fbid,mode:ka.IMMEDIATE,customHeader:mb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/mercury/pinned_threads/':{request_user_id:this._fbid,mode:ka.BATCH_SUCCESSIVE_UNIQUE,customHeader:mb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)},'/mercury/unpin_thread/':{request_user_id:this._fbid,mode:ka.IMMEDIATE,customHeader:mb,handler:function(ob,pb){return this.__handleUpdate(ob,pb);}.bind(this)}};ka.registerEndpoints(nb);},__sendRequest:function(mb,nb,ob){ka.trySend(mb,nb,ob,this._fbid);}});Object.assign(lb,da);e.exports=lb;},null);
__d("MercuryThreads",["EventEmitter","ImmutableObject","KeyedCallbackManager","LogHistory","Map","MercuryActionType","MercuryAssert","MercuryAttachment","MercuryGlobalActionType","MercuryIDs","MercuryLogMessageType","MercuryLoggingHelper","MercuryPayloadSource","MercurySingletonMixin","MercuryThreadMode","MessagingTag","MercuryServerRequests","Set","MercuryThreadInformer","fbt","setImmediate"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa){b.__markCompiled&&b.__markCompiled();'use strict';var ba=new g(),ca=j.getInstance('mercury_threads');function da(ea){this.$MercuryThreads0=ea;this.$MercuryThreads1=w.getForFBID(this.$MercuryThreads0);this.$MercuryThreads2=y.getForFBID(this.$MercuryThreads0);this.$MercuryThreads3=p.getParticipantIDFromUserID(this.$MercuryThreads0);this.$MercuryThreads4=false;this.$MercuryThreads5=new i();this.$MercuryThreads6=new x();this.$MercuryThreads7=false;this.$MercuryThreads8=new x();this.$MercuryThreads9=new x();this.$MercuryThreadsa();}da.prototype.getThreadMetaNow=function(ea){m.isThreadID(ea);return this.$MercuryThreads5.getResource(ea);};da.prototype.getOrFetch=function(ea){var fa=this.getThreadMetaNow(ea);if(!fa&&!this.$MercuryThreads9.has(ea))this.$MercuryThreads8.add(ea);if(this.$MercuryThreads8.size>0&&!this.$MercuryThreads7)this.$MercuryThreadsb();return fa;};da.prototype.$MercuryThreadsb=function(){if(this.$MercuryThreads7)return;this.$MercuryThreads7=true;aa(function(){this.$MercuryThreads7=false;this.$MercuryThreads8.forEach(function(ea){return this.$MercuryThreads9.add(ea);}.bind(this));this.getMultiThreadMeta(Array.from(this.$MercuryThreads8),function(ea){for(var fa in ea)ea.hasOwnProperty(fa)&&this.$MercuryThreads9["delete"](fa);}.bind(this));this.$MercuryThreads8.clear();}.bind(this));};da.prototype.getThreadMeta=function(ea,fa,ga){return this.getMultiThreadMeta([ea],function(ha){return fa(ha[ea]);},ga);};da.prototype.getMultiThreadMeta=function(ea,fa,ga){m.allThreadID(ea);var ha=this.$MercuryThreads5.executeOrEnqueue(ea,fa),ia=this.$MercuryThreads5.getUnavailableResources(ha);if(ia.length){var ja=[];for(var ka=0;ka<ia.length;ka++){var la=ia[ka],ma=p.tokenize(la),na=ma.type,oa=ma.value;if(na=='user'){var pa=p.getParticipantIDFromUserID(oa);this.createNewLocalThread(la,pa===this.$MercuryThreads3?[this.$MercuryThreads3]:[this.$MercuryThreads3,pa]);}else ja.push(la);}if(ja.length)this.$MercuryThreads1.fetchThreadData(ja,ga);}return ha;};da.addListener=function(ea,fa){return ba.addListener(ea,fa);};da.prototype.unsubscribe=function(ea){this.$MercuryThreads5.unsubscribe(ea);};da.prototype.getCanonicalThreadToParticipant=function(ea,fa,ga,ha){var ia=p.getThreadIDFromParticipantID(ea),ja=this.$MercuryThreads5.getResource(ia);if(typeof ja=='undefined'){ja=this.createNewLocalThread(ia,this.$MercuryThreads3===ea?[this.$MercuryThreads3]:[this.$MercuryThreads3,ea],fa);!ha&&this.$MercuryThreads1.fetchThreadData([ia],ga);}return ja;};da.prototype.createNewLocalThread=function(ea,fa,ga){var ha=this.$MercuryThreads5.getResource(ea);if(!ha){var ia=p.tokenize(ea),ja=ia.type,ka=ia.value;ha=new h({thread_id:ea,last_action_id:null,participants:Array.from(fa),name:null,snippet:'',snippet_has_attachment:false,snippet_sender:null,unread_count:ga?ga:0,message_count:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,canonical_fbid:ja==='user'?ka:null,is_canonical_user:ja=='user',is_canonical:this.$MercuryThreadsc(fa),is_subscribed:true,root_message_threading_id:null,folder:v.INBOX,is_archived:false,mode:u.TITAN_ORIGINATED});this.$MercuryThreads5.setResource(ea,ha);}return ha;};da.prototype.isEmptyLocalThread=function(ea){var fa=this.$MercuryThreads5.getResource(ea);if(!fa)return false;var ga=p.tokenize(ea),ha=ga.type;return ha=='root'&&!fa.timestamp;};da.prototype.isNewEmptyLocalThread=function(ea){if(!this.isEmptyLocalThread(ea))return false;var fa=this.$MercuryThreads5.getResource(ea);return !!fa.participants&&fa.participants.length===0;};da.prototype.$MercuryThreadsd=function(ea,fa){if(!ea||!ea.length)return;var ga=new k(),ha=new k(),ia=new k(),ja=[];for(var ka=0;ka<ea.length;ka++){var la=ea[ka];if(la.is_forward)continue;var ma=la.action_type;if(ma==l.LOG_MESSAGE&&la.log_message_type==q.SERVER_ERROR)continue;var na=!!(la.sync_id||la.action_id),oa=la.thread_id;m.isThreadID(oa);var pa=this.$MercuryThreads5.getResource(oa);if(!pa&&!na&&ma==l.USER_GENERATED_MESSAGE){pa=this.$MercuryThreadse(la);this.$MercuryThreads5.setResource(oa,pa);}if(!pa)continue;if(ma==l.LOG_MESSAGE||ma==l.USER_GENERATED_MESSAGE)na=!fa;if(pa.server_timestamp&&la.timestamp<=pa.server_timestamp&&na)continue;if(!ia.has(oa))ia.set(oa,Object.assign({},pa));this.$MercuryThreadsf(ia.get(oa),la,fa);if(ma==l.USER_GENERATED_MESSAGE)ga.set(oa,la);if(ma==l.USER_GENERATED_MESSAGE||ma==l.LOG_MESSAGE||ma==l.SEND_MESSAGE)if(la&&la.timestamp&&(!ha.has(oa)||la.timestamp>ha.get(oa).timestamp))ha.set(oa,la);}ia.forEach(function(qa,ra){var sa=ha.get(ra),ta=ga.get(ra);if(ta){this.$MercuryThreadsg(qa,ta);}else if(sa&&(sa.log_message_type==q.PHONE_CALL||sa.log_message_type==q.VIDEO_CALL)){var ua=Object.assign({},sa,{body:sa.log_message_body});this.$MercuryThreadsg(qa,ua);}var va=qa.timestamp;if(sa){if(sa.timestamp>va)Object.assign(qa,{timestamp_absolute:sa.timestamp_absolute,timestamp_relative:sa.timestamp_relative,timestamp:sa.timestamp});var wa=qa.server_timestamp;if(!fa&&sa.timestamp>wa)qa.server_timestamp=sa.timestamp;}var xa=new h(qa);this.$MercuryThreads5.setResource(ra,xa);ja.push(r.obfuscateThread(xa));}.bind(this),this);ja.length&&this.$MercuryThreads4&&ca.debug('threads_updated',{threads:ja});};da.prototype.$MercuryThreadsf=function(ea,fa,ga){var ha=fa.action_type;if(ha==l.USER_GENERATED_MESSAGE||ha==l.LOG_MESSAGE){fa.is_unread&&ea.unread_count++;ea.message_count++;ea.is_archived=false;}switch(ha){case l.DELETE_THREAD:ea.message_count=0;this.$MercuryThreadsh(fa.thread_id);break;case l.USER_GENERATED_MESSAGE:if(ea.last_read_timestamp>=fa.timestamp)this.$MercuryThreadsi(ea,fa,true);this.$MercuryThreadsj(ea,fa.author);break;case l.SEND_MESSAGE:var ia=fa.log_message_type;if(ia==q.THREAD_IMAGE){ea.image_src=fa.log_message_data.image?fa.log_message_data.image.preview_url:null;this.$MercuryThreadsk(fa.thread_id);}ea.snippet_attachments=fa.attachments;break;case l.LOG_MESSAGE:var ia=fa.log_message_type;if(ia==q.SUBSCRIBE){this.$MercuryThreadsl(ea,fa.log_message_data.added_participants);this.$MercuryThreadsk(fa.thread_id);}else if(ia==q.UNSUBSCRIBE){this.$MercuryThreadsm(ea,fa.log_message_data.removed_participants);this.$MercuryThreadsk();}else if(ia==q.THREAD_IMAGE){if(!ga)ea.image_src=fa.log_message_data.image?fa.log_message_data.image.preview_url:null;}else if(ia==q.THREAD_NAME){if(ea.name!==fa.log_message_data.name)this.$MercuryThreadsk(fa.thread_id);ea.name=fa.log_message_data.name;}break;case l.CHANGE_READ_STATUS:var ja=this.$MercuryThreadsi(ea,fa,fa.mark_as_read);if(ja&&fa.timestamp)ea.last_read_timestamp=fa.timestamp;if(ja&&ga)this.$MercuryThreads1.changeThreadReadStatus(ea.thread_id,fa.mark_as_read,fa.source);break;case l.CHANGE_ARCHIVED_STATUS:if(ea.is_archived!=fa.archived){ea.is_archived=fa.archived;this.$MercuryThreadsk(fa.thread_id);}break;case l.CHANGE_FOLDER:if(ea.folder!=fa.new_folder){ea.folder=fa.new_folder;this.$MercuryThreadsk(fa.thread_id);}break;case l.DELETE_MESSAGES:if(ga){ea.snippet='...';ea.snippet_has_attachment=false;ea.snippet_attachments=null;ea.snippet_sender=null;ea.is_forwarded_snippet=false;this.$MercuryThreadsk(fa.thread_id);}else if(fa.message_ids)ea.message_count=ea.message_count-fa.message_ids.length;break;case l.CHANGE_MUTE_SETTINGS:if(fa.mute_settings!==(void 0)){var ka=this.$MercuryThreads0+'@facebook.com';if(ea.mute_settings){if(fa.mute_settings){var la={};la[ka]=fa.mute_settings;ea.mute_settings=Object.assign({},ea.mute_settings,la);}else{ea.mute_settings=Object.assign({},ea.mute_settings);delete ea.mute_settings[ka];}this.$MercuryThreadsk(ea.thread_id);}}break;case l.ADD_PARTICIPANTS:this.$MercuryThreadsl(ea,fa.participants);this.$MercuryThreadsk(ea.thread_id);break;case l.CHANGE_FLAG:this.$MercuryThreadsn(ea,fa.mark_as_flag);this.$MercuryThreadsk(ea.thread_id);break;}};da.prototype.$MercuryThreadse=function(ea){var fa=p.tokenize(ea.thread_id),ga=fa.type,ha=fa.value,ia=this.$MercuryThreadsc(ea.specific_to_list);return new h({thread_id:ea.thread_id,last_action_id:null,participants:ea.specific_to_list,name:null,snippet:ea.body,snippet_has_attachment:false,snippet_attachments:[],snippet_sender:ea.author,unread_count:0,message_count:0,image_src:null,timestamp_absolute:ea.timestamp_absolute,timestamp_relative:ea.timestamp_relative,timestamp:ea.timestamp,canonical_fbid:ga==='user'?ha:null,is_canonical_user:ga==='user',is_canonical:ia,is_subscribed:true,root_message_threading_id:ea.message_id,folder:v.INBOX,is_archived:false,mode:u.TITAN_ORIGINATED});};da.prototype.$MercuryThreadsi=function(ea,fa,ga){if(fa.timestamp)this.$MercuryThreadso(ea.thread_id,ga,fa.timestamp);if(!ea||!ea.thread_id)return false;if(!ea.timestamp){this.$MercuryThreads6.add(ea.thread_id);return false;}var ha=!ea.unread_count;if(ga==ha)return false;ea.unread_count=ga?0:1;this.$MercuryThreadsk(ea.thread_id);return true;};da.prototype.$MercuryThreadsp=function(ea){var fa=this.$MercuryThreads5.getAllResources();for(var ga in fa)if(fa.hasOwnProperty(ga)){var ha=fa[ga];if(ha.folder==ea){this.$MercuryThreads5.setResource(ga,h.setProperty(ha,'unread_count',0));this.$MercuryThreadsk(ga);}}};da.prototype.$MercuryThreadsl=function(ea,fa){var ga=new x(ea.participants);ea.participants=Array.from(ea.participants);fa.forEach(function(ha){if(!ga.has(ha)){ea.participants.push(ha);if(ha===this.$MercuryThreads3)ea.is_subscribed=true;}}.bind(this));};da.prototype.$MercuryThreadsm=function(ea,fa){var ga=new x(fa);ea.participants=ea.participants.filter(function(ha){return !ga.has(ha);});if(ga.has(this.$MercuryThreads3))ea.is_subscribed=false;this.$MercuryThreads1.fetchThreadData([ea.thread_id]);};da.prototype.$MercuryThreadsj=function(ea,fa){if(ea.participants[0]!=fa){ea.participants=ea.participants.filter(function(ga){return ga!=fa;});ea.participants.unshift(fa);}};da.prototype.$MercuryThreadsg=function(ea,fa){var ga=fa.body,ha=fa.subject,ia='';if(ha){ha=ha.toLowerCase();if(ga.slice(0,ha.length).toLowerCase()==ha){ia=ga;}else if(ga){ia=ha+' \u00B7 '+ga;}else ia=ha;}else ia=ga;if(fa.is_filtered_content)ia=z._("Ta wiadomo\u015b\u0107 nie jest ju\u017c dost\u0119pna, bo zosta\u0142a oznaczona jako naruszenie zasad lub spam.");ea.snippet=ia;ea.snippet_has_attachment=fa.has_attachment;if(fa.raw_attachments&&fa.raw_attachments.length>0){var ja=n.convertRaw(fa.raw_attachments);ea.snippet_attachments=ja;}else ea.snippet_attachments=fa.attachments;ea.is_forwarded_snippet=!!fa.forward_count;ea.snippet_sender=fa.author;};da.prototype.$MercuryThreadsn=function(ea,fa){ea.page_thread_info=Object.assign({},ea.page_thread_info,{flagged:fa});};da.prototype.$MercuryThreadsc=function(ea){return ea.filter(function(fa){return fa!=this.$MercuryThreads3;}.bind(this)).length<=1;};da.prototype.$MercuryThreadsa=function(){this.$MercuryThreads1.subscribe('update-threads',function(ea,fa){var ga=(fa.actions||[]).filter(function(ha){return ha.thread_id;});if(fa.threads&&fa.payload_source==s.SERVER_FETCH_THREAD_INFO)fa.threads.forEach(function(ha){var ia=ha.thread_id;if(this.$MercuryThreads6.has(ia)){this.$MercuryThreads6["delete"](ia);if(ha.unread_count)this.$MercuryThreads1.changeThreadReadStatus(ha.thread_id,true);}}.bind(this));this.$MercuryThreadsq(fa.threads);this.$MercuryThreadsd(ga,fa.from_client);fa.threads&&fa.threads.forEach(function(ha){this.$MercuryThreadsk(ha.thread_id);}.bind(this));if(fa.global_actions)fa.global_actions.forEach(function(ha){if(ha.action_type==o.MARK_ALL_READ)this.$MercuryThreadsp(ha.folder);}.bind(this));if(this.$MercuryThreads4){this.$MercuryThreads4=false;ba.emit('change');}}.bind(this));};da.prototype.$MercuryThreadsq=function(ea){if(!ea||!ea.length)return;var fa={},ga=[];ea.forEach(function(ha){var ia=new h(ha);fa[ha.thread_id]=ia;ga.push(r.obfuscateThread(ia));});ga.length&&ca.debug('threads_added',{threads:ga});this.$MercuryThreads5.addResourcesAndExecute(fa);};da.prototype.$MercuryThreadsk=function(ea){this.$MercuryThreads4=true;this.$MercuryThreads2.updatedThread(ea);};da.prototype.$MercuryThreadsh=function(ea){this.$MercuryThreads4=true;this.$MercuryThreads2.deletedThread(ea);};da.prototype.$MercuryThreadso=function(ea,fa,ga){this.$MercuryThreads4=true;this.$MercuryThreads2.changedThreadReadState(ea,fa,ga);};Object.assign(da,t);e.exports=da;},null);
__d("WebMessengerPermalinkConstants",["MercuryConfig","URI"],function(a,b,c,d,e,f,g,h){b.__markCompiled&&b.__markCompiled();var i={ARCHIVED_PATH:'/messages/archived',BASE_PATH:'/messages',PENDING_PATH:'/messages/pending',OTHER_PATH:'/messages/other',SPAM_PATH:'/messages/spam',COMPOSE_POSTFIX_PATH:'/new',SEARCH_POSTFIX_PATH:'/search',TID_POSTFIX_PARTIAL_PATH:'/conversation-',overriddenVanities:g.CoreGraphEnabled?'(archived|other|pending|spam|new|search|conversation-.*)':'(archived|other|spam|new|search|conversation-.*)',getURIPathForThreadID:function(j,k){return (k||i.BASE_PATH)+i.TID_POSTFIX_PARTIAL_PATH+h.encodeComponent(h.encodeComponent(j));},getThreadIDFromURI:function(j){var k=j.getPath().match(i.BASE_PATH+'(/[^/]*)*'+i.TID_POSTFIX_PARTIAL_PATH+'([^/]+)');if(k){var l=h.decodeComponent(h.decodeComponent(k[2]));return l;}},getURIPathForIDOrVanity:function(j,k){if(j.match('^'+i.overriddenVanities+'$'))j='.'+j;return (k||i.BASE_PATH)+'/'+j;},getUserIDOrVanity:function(j){var k=j.match(i.BASE_PATH+'.*/([^/]+)/?$'),l=k&&k[1],m=i.overriddenVanities;if(!l||l.match('^'+m+'$')){return false;}else if(l.match('^\\.'+m+'$')){return l.substr(1);}else return l;}};e.exports=i;},null);
__d("ChatOpenTab",["AsyncRequest","Event","requireWeak","ChatWelcomeMessage","ContextualThing","DOM","csx","cx","MercuryIDs","Parent","XAdsQEExposureController"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){b.__markCompiled&&b.__markCompiled();var r=null;i(['ChatApp'],function(ba){return r=ba;});var s=null;i(['ChatTabModel'],function(ba){return s=ba;});var t=716,u='messaging_tracking';function v(){d(['Toggler'],function(ba){var ca=ba.getInstance(l.scry(document,"div._1z4y")[0]);if(ca&&ca.getActive())ca.hide();});}function w(ba,ca){d(['LogHistory','MercuryThreads','WebMessengerPermalinkConstants','goURI'],function(da,ea,fa,ga){ea.get().getThreadMeta(ba,function(ha){if(r&&r.isInitialized()){r.tabController.openTab(ba,r.tabsViewport,ca);}else ga(fa.getURIPathForThreadID(ba));if(!aa.canOpenTab())da.getInstance('mercury').error('Unable to open chat tab',ha);});});if(document.documentElement.clientHeight<=t)v();}function x(ba,ca,da,ea,fa){h.listen(ba,'click',function(ga){if(aa.canOpenTab()){ea(ca,da);if(fa)return;return ga.kill();}});}function y(ba,ca,da,ea){var fa={referrer:ba||'',message_thread_id:ca,message_view:'chat',timestamp_send:Date.now()};if(da!==(void 0))fa.message_target_ids=[da];d(['ChatImpressionLogger'],function(ga){ga.logImpression(ba,da,ea);});d(['Banzai'],function(ga){ga.post(u,fa,{delay:0,retry:true});});}function z(ba){var ca=k.getContext(ba);return (ca&&p.byClass(ca,"_3qw")!==null);}var aa={canOpenTab:function(){return r&&!r.isHidden();},openEmptyTab:function(ba,ca,da){if(aa.canOpenTab()&&s){var ea=s.getEmptyTab();w(ea);y(ca,ea,null,da);v();return ea;}return null;},listenOpenEmptyTab:function(ba,ca){x(ba,null,ca,aa.openEmptyTab);},openThread:function(ba,ca,da,ea){d(['MercuryThreadIDMap'],function(fa){if(o.isValid(ba)){w(ba,ea);}else fa.get().getClientIDFromFBID(ba,function(ga){return w(ga,ea);});y(ca,ba,null,da);v();});},listenOpenThread:function(ba,ca,da){x(ba,ca,da,aa.openThread);},openUserTab:function(ba,ca,da){var ea=o.getThreadIDFromUserID(ba);w(ea);y(ca,ea,ba,da);return true;},openPageTab:function(ba,ca,da){d(['MercuryThreads'],function(ea){var fa=o.getThreadIDFromUserID(ca);ea.get().getThreadMeta(fa,function(ga){if(ba&&ba.length>0){var ha=(Date.now()-ga.timestamp)/1000,ia=ha/3600;if(ga.message_count===0||ia>24)j.setWelcomeMessage(fa,o.getParticipantIDFromUserID(ca),ba);}});w(fa);y(da,fa,ca);});return true;},listenOpenUserTab:function(ba,ca,da){if(!z(ba))x(ba,ca,da,aa.openUserTab);},listenOpenPageTab:function(ba,ca,da,ea,fa){if(!z(ba))x(ba,ca,ea,function(ga,ha){if(fa)this.openPageTab(da,ga,ha);var ia=q.getURIBuilder().setString('name','switch_dialog_for_chat').setString('id',ga.toString());new g().setURI(ia.getURI()).setMethod('POST').send();}.bind(this),!fa);},openTabByType:function(ba,ca,da){d(['ChatTypeaheadConstants','MercuryParticipantTypes'],function(ea,fa){if(ca===ea.THREAD_TYPE){if(ba){aa.openThread(ba,da);}else aa.openEmptyTab(null,da);}else if(!ca||ca===fa.FRIEND||ca===ea.FRIEND_TYPE||ca===ea.PAGE_TYPE||ca===ea.USER_TYPE)aa.openUserTab(ba,da);});}};e.exports=aa;},null);
__d("MercuryFolders",["MercuryConfig","MessagingTag","arrayContains"],function(a,b,c,d,e,f,g,h,i){b.__markCompiled&&b.__markCompiled();var j=[h.INBOX,h.OTHER,h.ACTION_ARCHIVED,h.SPAM],k=[h.INBOX,h.PENDING,h.OTHER,h.ACTION_ARCHIVED],l={getSupportedFolders:function(){return g.CoreGraphEnabled?k.concat():j.concat();},isSupportedFolder:function(m){return i(j,m);},getFromMeta:function(m){var n=m.folder;if(m.is_archived)n=h.ACTION_ARCHIVED;return n;}};e.exports=l;},null);
__d("MercuryUnreadState",["MercuryFolders","LogHistory","KeyedCallbackManager","MercuryActionType","MercuryGlobalActionType","MercurySingletonMixin","MercuryThreadlistConstants","MercuryThreadIDMap","MessagingTag","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","arrayContains","copyProperties","createObjectFrom"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u){b.__markCompiled&&b.__markCompiled();var v=(g.getSupportedFolders()||[]).filter(function(na){return na!=o.ACTION_ARCHIVED;}),w='unread_thread_hash',x='unseen_thread_list',y=m.MAX_UNREAD_COUNT,z=h.getInstance('mercury_unread_state');function aa(na){this._fbid=na;this._serverRequests=p.getForFBID(this._fbid);this._threadIDMap=n.getForFBID(this._fbid);this._threadInformer=q.getForFBID(this._fbid);this._threads=r.getForFBID(this._fbid);this._allReadTimestamp={};this._threadReadTimestamp={};this._initialUnreadCount={};this._maxCount={};this._unreadResources={};v.forEach(function(oa){this._initialUnreadCount[oa]=0;this._maxCount[oa]=false;this._unreadResources[oa]=new i();}.bind(this));this._serverRequests.subscribe('update-unread',function(oa,pa){fa(this,pa);var qa=pa.global_actions||[];for(var ra=0;ra<qa.length;ra++){var sa=qa[ra];if(sa.action_type==k.MARK_ALL_READ)ia(this,sa.folder,sa.timestamp);}}.bind(this));this._serverRequests.subscribe('update-thread-ids',function(oa,pa){ka(this,pa);}.bind(this));}t(aa.prototype,{getUnreadCount:function(na){if(this.exceedsMaxCount(na)){z.error('unguarded_unread_count_fetch',{});return 0;}return ea(this,na);},exceedsMaxCount:function(na){return this._maxCount[na]||(ea(this,na)>y);},markFolderAsRead:function(na){if(this._maxCount[na]||ea(this,na)>0)this._serverRequests.markFolderAsRead(na);},getIsThreadUnread:function(na,oa){var pa=oa||o.INBOX,qa=da(this,pa);return qa&&qa[na];}});t(aa,l);function ba(na,oa,pa){na._unreadResources[oa].setResource(w,pa);na._unreadResources[oa].setResource(x,Object.keys(pa));}function ca(na,oa,pa){var qa=na._unreadResources[oa].executeOrEnqueue(w,pa),ra=na._unreadResources[oa].getUnavailableResources(qa);if(ra.length)na._serverRequests.fetchUnreadThreadIDs(oa);}function da(na,oa){return na._unreadResources[oa].getResource(w);}function ea(na,oa){var pa=na._unreadResources[oa].getResource(x);if(pa){return pa.length;}else return na._initialUnreadCount[oa];}function fa(na,oa){var pa;(oa.unread_thread_fbids||[]).forEach(function(qa){pa=qa.folder;if(!ma(pa))return;var ra=qa.thread_fbids||[];ra=ra.concat(qa.other_user_fbids||[]);var sa=ja(na,ra);ba(na,pa,u(sa,true));if(sa.length>y)na._maxCount[pa]=true;na._threadInformer.updatedUnreadState();});(oa.message_counts||[]).forEach(function(qa){if(qa.unread_count===(void 0))return;pa=qa.folder;if(qa.unread_count>y){na._maxCount[pa]=true;ba(na,pa,{});na._threadInformer.updatedUnreadState();}else{na._initialUnreadCount[pa]=qa.unread_count;if(na._initialUnreadCount[pa]===0)ba(na,pa,{});na._threadInformer.updatedUnreadState();}});(oa.actions||[]).forEach(function(qa){if(qa.is_forward)return;var ra=j,sa=qa.other_user_fbid?qa.other_user_fbid:qa.thread_fbid,ta=qa.thread_id?qa.thread_id:sa;if(qa.action_type==ra.DELETE_THREAD){v.forEach(function(va){ha(na,va,ta);});}else if(qa.action_type==ra.CHANGE_ARCHIVED_STATUS||qa.action_type==ra.CHANGE_FOLDER){var ua=na._threads.getThreadMetaNow(qa.thread_id);pa=g.getFromMeta(ua);if(ma(pa)&&ua.unread_count>0)ga(na,pa,ta);v.forEach(function(va){if(va!=pa)ha(na,va,ta);});}else{pa=la(na,qa);if(!ma(pa))return;if(qa.action_type==ra.CHANGE_READ_STATUS){if(qa.mark_as_read){ha(na,pa,ta,qa.timestamp);}else ga(na,pa,ta,qa.timestamp);}else if(qa.action_type==ra.USER_GENERATED_MESSAGE||qa.action_type==ra.LOG_MESSAGE)if(qa.is_unread)ga(na,pa,ta,qa.timestamp);}});}function ga(na,oa,pa,qa){if(na._maxCount[oa])return;ca(na,oa,function(ra){var sa=na._allReadTimestamp[oa]||0,ta=na._threadReadTimestamp[pa]||0,ua=qa||Number.POSITIVE_INFINITY;if(ua>=sa&&ua>=ta&&!ra[pa]){ra[pa]=qa||0;ba(na,oa,ra);na._threadInformer.updatedUnreadState();}});}function ha(na,oa,pa,qa){if(na._maxCount[oa])return;ca(na,oa,function(ra){if(qa){var sa=na._threadReadTimestamp[pa];if(!sa||sa<qa)na._threadReadTimestamp[pa]=qa;}var ta=ra[pa];if(qa&&typeof ta=='number'&&qa<ta)return;if(pa in ra){delete ra[pa];ba(na,oa,ra);na._threadInformer.updatedUnreadState();}});}function ia(na,oa,pa){na._maxCount[oa]=false;ba(na,oa,{});na._allReadTimestamp[oa]=Math.max(na._allReadTimestamp[oa]||0,pa||0);na._threadInformer.updatedUnreadState();}function ja(na,oa){return oa.map(na._threadIDMap.convertThreadIDIfAvailable,na._threadIDMap);}function ka(na,oa){v.forEach(function(pa){var qa=da(na,pa);if(!qa)return;for(var ra in oa){var sa=oa[ra];if(qa[ra]){qa[sa]=qa[ra];delete qa[ra];}}ba(na,pa,qa);});}function la(na,oa){var pa=oa.thread_id?na._threads.getThreadMetaNow(oa.thread_id):null;return pa?g.getFromMeta(pa):oa.folder;}function ma(na){return s(v,na);}e.exports=aa;},null);
__d("MercuryViewer",["CurrentUser","MercuryAssert"],function(a,b,c,d,e,f,g,h){b.__markCompiled&&b.__markCompiled();'use strict';var i='fbid:'+g.getID(),j={getID:function(){return i;},isViewer:function(k){h.isParticipantID(k);return k===i;}};e.exports=j;},null);
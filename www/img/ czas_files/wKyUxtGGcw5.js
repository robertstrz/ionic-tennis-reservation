/*!CK:2344927336!*//*1430155962,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["tMIIb"]); }

__d("PresencePoller",["AvailableListConstants","AvailableListInitialData","BanzaiODS","ChannelConnection","ChatContexts","ChatVisibility","CurrentUser","JSLogger","LastMobileActiveTimes","Poller","PresencePrivacy","PresenceStatus","ServerTime","ShortProfiles","UserActivity","copyProperties","debounceAcrossTransitions","errorCode"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x){b.__markCompiled&&b.__markCompiled();var y=5,z='/ajax/chat/buddy_list.php',aa=1800000,ba=h.pollInterval,ca=h.lazyPollInterval,da=h.lazyThreshold,ea=n.create('available_list'),fa='presence_poller';i.setEntitySample(fa,.01);function ga(ha){"use strict";this.$PresencePoller0=ha;this.$PresencePoller1=false;this.$PresencePoller2=h.chatNotif;this.$PresencePoller3=new p({interval:ba,setupRequest:this.$PresencePoller4.bind(this),clearOnQuicklingEvents:false,dontStart:true});if(l.isOnline()){this.$PresencePoller5=Date.now();this.$PresencePoller6=Date.now();this.$PresencePoller7=Date.now();this.$PresencePoller8=h.updateTime;}else{this.$PresencePoller5=0;this.$PresencePoller8=0;this.$PresencePoller6=0;this.$PresencePoller7=0;}this.$PresencePoller9=0;this.$PresencePollera('available_initial_data',h.updateTime,h.availableList,h.lastActiveTimes,h.mobileFriends);u.subscribe(function(ia,ja){if(ja.idleness>ba)this.forceUpdate();}.bind(this));q.subscribe('privacy-user-presence-changed',function(){this.forceUpdate();}.bind(this));}ga.prototype.start=function(){"use strict";setTimeout(this.$PresencePoller3.start.bind(this.$PresencePoller3),0);};ga.prototype.restart=function(){"use strict";if(this.$PresencePoller3.isMuted()){this.$PresencePoller3.resume();this.forceUpdate();}};ga.prototype.stop=function(){"use strict";this.$PresencePoller3.mute();};ga.prototype.forceUpdate=function(){"use strict";this.$PresencePoller3.request();};ga.prototype.getIsUserIdle=function(){"use strict";return this.$PresencePoller1;};ga.prototype.getWebChatNotification=function(){"use strict";return this.$PresencePoller2;};ga.prototype.getCallback=function(){"use strict";return this.$PresencePoller0;};ga.prototype.$PresencePollerb=function(){"use strict";return w(function(){this.$PresencePoller0(g.ON_AVAILABILITY_CHANGED);}.bind(this),0)();};ga.prototype.$PresencePollera=function(ha,ia,ja,ka,la){"use strict";this.$PresencePoller8=ia;if(!Array.isArray(ja)){r.resetPresenceData();for(var ma in ja)r.set(ma,ja[ma].a,false,ha,ja[ma].c,ja[ma].p);}if(ka&&!Array.isArray(ka))o.update(ka);if(la)r.setMobileFriends(la);this.$PresencePollerb();};ga.prototype.$PresencePoller4=function(ha){"use strict";if(j.isShutdown()||!l.isOnline()){this.$PresencePoller3.skip();i.bumpEntityKey(fa,'skip.offline');return;}if(Date.now()-this.$PresencePoller5<ba){this.$PresencePoller3.skip();i.bumpEntityKey(fa,'skip.recent');return;}i.bumpEntityKey(fa,'request');this.$PresencePoller5=Date.now();var ia=Date.now()-this.$PresencePoller7,ja=t.getCachedProfileIDs().join(",");ha.setHandler(this.$PresencePollerc.bind(this)).setErrorHandler(this.$PresencePollerd.bind(this)).setOption('suppressErrorAlerts',true).setOption('retries',1).setData({user:m.getID(),cached_user_info_ids:ja,fetch_mobile:(ia>aa)}).setURI(z).setAllowCrossPageTransition(true);};ga.prototype.$PresencePollerc=function(ha){"use strict";var ia=ha.getPayload(),ja=ia.buddy_list;if(!ja){this.$PresencePollerd(ha);return;}i.bumpEntityKey(fa,'response');this.$PresencePollere();this.$PresencePoller6=Date.now();s.update(ia.time);if(ja.mobile_friends)this.$PresencePoller7=Date.now();this.$PresencePoller9=0;this.$PresencePollerf();var ka=ja.userInfos;if(ka)t.setMulti(ka);var la=ja.chatContexts;la&&k.update(la);this.$PresencePoller1=ja.userIsIdle;if(ja.chatNotif!==(void 0)){this.$PresencePoller2=ja.chatNotif;this.$PresencePoller0(g.ON_CHAT_NOTIFICATION_CHANGED,this.$PresencePoller2);}this.$PresencePollera('buddy_list_poller',ia.time,ja.nowAvailableList,ja.last_active_times,ja.mobile_friends);};ga.prototype.$PresencePollerd=function(ha){"use strict";i.bumpEntityKey(fa,'error');if(ha.getError()==1356007)return;this.$PresencePoller9++;if(this.$PresencePoller9>=y)this.$PresencePoller0(g.ON_UPDATE_ERROR);};ga.prototype.$PresencePollerf=function(){"use strict";var ha=u.isActive(da)?ba:ca;i.bumpEntityKey(fa,'period.'+ha);this.$PresencePoller3.setInterval(ha);};ga.prototype.$PresencePollere=function(){"use strict";var ha=Date.now(),ia=ha-this.$PresencePoller6;ea.log('buddylist_presence_stats',v({duration:ia},r.getPresenceStats()));};e.exports=ga;},null);